!function(o,n){"function"==typeof define&&define.amd?define("simditor",["jquery","simple-module","simple-hotkeys","simple-uploader"],function(t,e,i,r){return o.Simditor=n(t,e,i,r)}):"object"==typeof exports?module.exports=n(require("jquery"),require("simplemodule"),require("simple-hotkeys"),require("simple-uploader")):o.Simditor=n(jQuery,SimpleModule,simple.hotkeys,simple.uploader)}(this,function(A,p,u,a){var t,e,n,l,d,h,i,r,o,s,c,f,g,m,v,y,b,_,w,x,T,k,C,E,B,R,N,S,M,O,I,H,D=function(t,e){function i(){this.constructor=t}for(var r in e)z.call(e,r)&&(t[r]=e[r]);return i.prototype=e.prototype,t.prototype=new i,t.__super__=e.prototype,t},z={}.hasOwnProperty,K=[].indexOf||function(t){for(var e=0,i=this.length;e<i;e++)if(e in this&&this[e]===t)return e;return-1},P=[].slice;return k=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return D(e,t),e.pluginName="Selection",e.prototype._init=function(){return this.editor=this._module,this.sel=document.getSelection()},e.prototype.clear=function(){try{return this.sel.removeAllRanges()}catch(t){t}},e.prototype.getRange=function(){return this.editor.inputManager.focused&&this.sel.rangeCount?this.sel.getRangeAt(0):null},e.prototype.selectRange=function(t){return this.clear(),this.sel.addRange(t),this.editor.inputManager.focused||!this.editor.util.browser.firefox&&!this.editor.util.browser.msie||this.editor.body.focus(),t},e.prototype.rangeAtEndOf=function(t,e){var i,r,o;return null==e&&(e=this.getRange()),null!=e&&e.collapsed?(t=A(t)[0],i=e.endContainer,r=this.editor.util.getNodeLength(i),!!(e.endOffset===r-1&&A(i).contents().last().is("br")||e.endOffset===r)&&(t===i||!!A.contains(t,i)&&(o=!0,A(i).parentsUntil(t).addBack().each(function(t,e){var i;return(i=A(e).parent().contents().filter(function(){return!(this!==e&&3===this.nodeType&&!this.nodeValue)}).last()).get(0)===e||i.is("br")&&i.prev().get(0)===e?void 0:o=!1}),o))):void 0},e.prototype.rangeAtStartOf=function(t,e){var i,r;return null==e&&(e=this.getRange()),null!=e&&e.collapsed?(t=A(t)[0],r=e.startContainer,0===e.startOffset&&(t===r||!!A.contains(t,r)&&(i=!0,A(r).parentsUntil(t).addBack().each(function(t,e){return A(e).parent().contents().filter(function(){return!(this!==e&&3===this.nodeType&&!this.nodeValue)}).first().get(0)!==e?i=!1:void 0}),i))):void 0},e.prototype.insertNode=function(t,e){return null==e&&(e=this.getRange()),null!=e?(t=A(t)[0],e.insertNode(t),this.setRangeAfter(t,e)):void 0},e.prototype.setRangeAfter=function(t,e){return null==e&&(e=this.getRange()),null!=e?(t=A(t)[0],e.setEndAfter(t),e.collapse(!1),this.selectRange(e)):void 0},e.prototype.setRangeBefore=function(t,e){return null==e&&(e=this.getRange()),null!=e?(t=A(t)[0],e.setEndBefore(t),e.collapse(!1),this.selectRange(e)):void 0},e.prototype.setRangeAtStartOf=function(t,e){return null==e&&(e=this.getRange()),t=A(t).get(0),e.setEnd(t,0),e.collapse(!1),this.selectRange(e)},e.prototype.setRangeAtEndOf=function(t,e){var i,r,o,n,s,a;return null==e&&(e=this.getRange()),t=(r=A(t)).get(0),r.is("pre")?0<(o=r.contents()).length?"\n"===(s=(n=o.last()).text()).charAt(s.length-1)?e.setEnd(n[0],this.editor.util.getNodeLength(n[0])-1):e.setEnd(n[0],this.editor.util.getNodeLength(n[0])):e.setEnd(t,0):(a=this.editor.util.getNodeLength(t),3!==t.nodeType&&0<a&&((i=A(t).contents().last()).is("br")?a-=1:3!==i[0].nodeType&&this.editor.util.isEmptyNode(i)&&(i.append(this.editor.util.phBr),t=i[0],a=0)),e.setEnd(t,a)),e.collapse(!1),this.selectRange(e)},e.prototype.deleteRangeContents=function(t){var e,i;return null==t&&(t=this.getRange()),i=t.cloneRange(),e=t.cloneRange(),i.collapse(!0),e.collapse(!1),!t.collapsed&&this.rangeAtStartOf(this.editor.body,i)&&this.rangeAtEndOf(this.editor.body,e)?(this.editor.body.empty(),t.setStart(this.editor.body[0],0),t.collapse(!0),this.selectRange(t)):t.deleteContents(),t},e.prototype.breakBlockEl=function(t,e){var i;return null==e&&(e=this.getRange()),i=A(t),e.collapsed?(e.setStartBefore(i.get(0)),e.collapsed?i:i.before(e.extractContents())):i},e.prototype.save=function(t){var e,i,r;return null==t&&(t=this.getRange()),this._selectionSaved?void 0:((i=t.cloneRange()).collapse(!1),r=A("<span/>").addClass("simditor-caret-start"),e=A("<span/>").addClass("simditor-caret-end"),i.insertNode(e[0]),t.insertNode(r[0]),this.clear(),this._selectionSaved=!0)},e.prototype.restore=function(){var t,e,i,r,o,n,s;return!!this._selectionSaved&&(o=this.editor.body.find(".simditor-caret-start"),t=this.editor.body.find(".simditor-caret-end"),o.length&&t.length?(s=(n=o.parent()).contents().index(o),i=(e=t.parent()).contents().index(t),n[0]===e[0]&&(i-=1),(r=document.createRange()).setStart(n.get(0),s),r.setEnd(e.get(0),i),o.remove(),t.remove(),this.selectRange(r)):(o.remove(),t.remove()),this._selectionSaved=!1,r)},e}(p),i=function(){function t(){return t.__super__.constructor.apply(this,arguments)}return D(t,p),t.pluginName="Formatter",t.prototype.opts={allowedTags:null,allowedAttributes:null},t.prototype._init=function(){return this.editor=this._module,this._allowedTags=this.opts.allowedTags||["br","a","img","b","strong","i","u","font","p","ul","ol","li","blockquote","pre","h1","h2","h3","h4","hr"],this._allowedAttributes=this.opts.allowedAttributes||{img:["src","alt","width","height","data-image-src","data-image-size","data-image-name","data-non-image"],a:["href","target"],font:["color"],pre:["data-lang","class"],p:["data-indent"],h1:["data-indent"],h2:["data-indent"],h3:["data-indent"],h4:["data-indent"]},this.editor.body.on("click","a",function(){return!1})},t.prototype.decorate=function(t){return null==t&&(t=this.editor.body),this.editor.trigger("decorate",[t])},t.prototype.undecorate=function(t){return null==t&&(t=this.editor.body.clone()),this.editor.trigger("undecorate",[t]),A.trim(t.html())},t.prototype.autolink=function(o){var t,n,e,i,r,s,a,l,d,u,p;for(null==o&&(o=this.editor.body),s=[],(n=function(t){return t.contents().each(function(t,e){var i,r;return(i=A(e)).is("a")||i.closest("a, pre",o).length?void 0:i.contents().length?n(i):(r=i.text())&&/https?:\/\/|www\./gi.test(r)?s.push(i):void 0})})(o),l=/(https?:\/\/|www\.)[\w\-\.\?&=\/#%:,@\!\+]+/gi,e=0,r=s.length;e<r;e++){for(u=(t=s[e]).text(),d=[],a=null,i=0;null!==(a=l.exec(u));)d.push(document.createTextNode(u.substring(i,a.index))),i=l.lastIndex,p=/^(http(s)?:\/\/|\/)/.test(a[0])?a[0]:"http://"+a[0],d.push(A('<a href="'+p+'" rel="nofollow"></a>').text(a[0])[0]);d.push(document.createTextNode(u.substring(i))),t.replaceWith(A(d))}return o},t.prototype.format=function(t){var e,i,r,o,n,s,a,l,d,u;if(null==t&&(t=this.editor.body),t.is(":empty"))return t.append("<p>"+this.editor.util.phBr+"</p>"),t;for(r=0,n=(d=t.contents()).length;r<n;r++)a=d[r],this.cleanNode(a,!0);for(o=0,s=(u=t.contents()).length;o<s;o++)l=u[o],(e=A(l)).is("br")?(null!=i&&(i=null),e.remove()):this.editor.util.isBlockNode(l)?e.is("li")?(i&&i.is("ul, ol")||(i=A("<ul/>").insertBefore(l)),i.append(l)):i=null:((!i||i.is("ul, ol"))&&(i=A("<p/>").insertBefore(l)),i.append(l));return t},t.prototype.cleanNode=function(t,e){var i,r,o,n,s,a,l,d,u,p,h,c,f,g,m,v,y;if(0<(r=A(t)).length){if(3===r[0].nodeType)return void((v=r.text().replace(/(\r\n|\n|\r)/gm,""))?(y=document.createTextNode(v),r.replaceWith(y)):r.remove());if(l=r.contents(),d=r.is('[class^="simditor-"]'),r.is(this._allowedTags.join(","))||d){if(r.is("a")&&0<(i=r.find("img")).length&&(r.replaceWith(i),r=i,l=null),r.is("img")&&r.hasClass("uploading")&&r.remove(),!d)for(s=this._allowedAttributes[r[0].tagName.toLowerCase()],u=0,h=(g=A.makeArray(r[0].attributes)).length;u<h;u++)a=g[u],null!=s&&(m=a.name,0<=K.call(s,m))||r.removeAttr(a.name)}else 1!==r[0].nodeType||r.is(":empty")?(r.remove(),l=null):r.is("div, article, dl, header, footer, tr")?(r.append("<br/>"),l.first().unwrap()):r.is("table")?(o=A("<p/>"),r.find("tr").each(function(t,e){return o.append(A(e).text()+"<br/>")}),r.replaceWith(o),l=null):r.is("thead, tfoot")?(r.remove(),l=null):r.is("th")?(n=A("<td/>").append(r.contents()),r.replaceWith(n)):l.first().unwrap();if(e&&null!=l&&!r.is("pre"))for(p=0,c=l.length;p<c;p++)f=l[p],this.cleanNode(f,!0);return null}},t.prototype.clearHtml=function(t,o){var e,n,s,a;return null==o&&(o=!0),e=A("<div/>").append(t),n=e.contents(),s="",n.each((a=this,function(t,e){var i,r;return 3===e.nodeType?s+=e.nodeValue:1===e.nodeType&&(0<(r=(i=A(e)).contents()).length&&(s+=a.clearHtml(r)),o&&t<n.length-1&&i.is("br, p, div, li, tr, pre, address, artticle, aside, dl, figcaption, footer, h1, h2, h3, h4, header"))?s+="\n":void 0})),s},t.prototype.beautify=function(t){var r;return r=function(t){return!!(t.is("p")&&!t.text()&&t.children(":not(br)").length<1)},t.each(function(t,e){var i;return(i=A(e)).is(':not(img, br, col, td, hr, [class^="simditor-"]):empty')&&i.remove(),r(i)&&i.remove(),i.find(':not(img, br, col, td, hr, [class^="simditor-"]):empty').remove()})},t}(),g=function(){function t(){return t.__super__.constructor.apply(this,arguments)}return D(t,p),t.pluginName="InputManager",t.prototype.opts={pasteImage:!1},t.prototype._modifierKeys=[16,17,18,91,93,224],t.prototype._arrowKeys=[37,38,39,40],t.prototype._init=function(){var t,e,i,o,r,n,s,a,l,d;return this.editor=this._module,this.throttledTrigger=this.editor.util.throttle((d=this,function(){var e;return e=1<=arguments.length?P.call(arguments,0):[],setTimeout(function(){var t;return(t=d.editor).trigger.apply(t,e)},10)}),300),this.opts.pasteImage&&"string"!=typeof this.opts.pasteImage&&(this.opts.pasteImage="inline"),this._keystrokeHandlers={},this.hotkeys=u({el:this.editor.body}),this._pasteArea=A("<div/>").css({width:"1px",height:"1px",overflow:"hidden",position:"fixed",right:"0",bottom:"100px"}).attr({tabIndex:"-1",contentEditable:!0}).addClass("simditor-paste-area").appendTo(this.editor.el),A(document).on("selectionchange.simditor"+this.editor.id,(l=this,function(){return l.focused?(l._selectionTimer&&(clearTimeout(l._selectionTimer),l._selectionTimer=null),l._selectionTimer=setTimeout(function(){return l.editor.trigger("selectionchanged")},20)):void 0})),this.editor.on("valuechanged",(a=this,function(){return!a.editor.util.closestBlockEl()&&a.focused&&(a.editor.selection.save(),a.editor.formatter.format(),a.editor.selection.restore()),a.editor.body.find("hr, pre, .simditor-table").each(function(t,e){var i,r;return((i=A(e)).parent().is("blockquote")||i.parent()[0]===a.editor.body[0])&&(r=!1,0===i.next().length&&(A("<p/>").append(a.editor.util.phBr).insertAfter(i),r=!0),0===i.prev().length&&(A("<p/>").append(a.editor.util.phBr).insertBefore(i),r=!0),r)?setTimeout(function(){return a.editor.trigger("valuechanged")},10):void 0}),a.editor.body.find("pre:empty").append(a.editor.util.phBr),!a.editor.util.support.onselectionchange&&a.focused?a.editor.trigger("selectionchanged"):void 0})),this.editor.on("selectionchanged",(s=this,function(){return s.editor.undoManager.update()})),this.editor.body.on("keydown",A.proxy(this._onKeyDown,this)).on("keypress",A.proxy(this._onKeyPress,this)).on("keyup",A.proxy(this._onKeyUp,this)).on("mouseup",A.proxy(this._onMouseUp,this)).on("focus",A.proxy(this._onFocus,this)).on("blur",A.proxy(this._onBlur,this)).on("paste",A.proxy(this._onPaste,this)).on("drop",A.proxy(this._onDrop,this)).on("input",A.proxy(this._onInput,this)),this.editor.util.browser.firefox&&(this.addShortcut("cmd+left",(n=this,function(t){return t.preventDefault(),n.editor.selection.sel.modify("move","backward","lineboundary"),!1})),this.addShortcut("cmd+right",(r=this,function(t){return t.preventDefault(),r.editor.selection.sel.modify("move","forward","lineboundary"),!1})),this.addShortcut("cmd+a",(o=this,function(){var t,e,i,r;return 0<(t=o.editor.body.children()).length?(e=t.first().get(0),i=t.last().get(0),(r=document.createRange()).setStart(e,0),r.setEnd(i,o.editor.util.getNodeLength(i)),o.editor.selection.selectRange(r),!1):void 0}))),t=this.editor.util.os.mac?"cmd+enter":"ctrl+enter",this.addShortcut(t,(i=this,function(){return i.editor.el.closest("form").find("button:submit").click(),!1})),this.editor.textarea.attr("autofocus")?setTimeout((e=this,function(){return e.editor.focus()}),0):void 0},t.prototype._onFocus=function(){return this.editor.el.addClass("focus").removeClass("error"),this.focused=!0,this.lastCaretPosition=null,setTimeout((t=this,function(){return t.editor.triggerHandler("focus"),t.editor.trigger("selectionchanged")}),0);var t},t.prototype._onBlur=function(){var t;return this.editor.el.removeClass("focus"),this.editor.sync(),this.focused=!1,this.lastCaretPosition=null!=(t=this.editor.undoManager.currentState())?t.caret:void 0,this.editor.triggerHandler("blur")},t.prototype._onMouseUp=function(){return this.editor.util.support.onselectionchange?void 0:setTimeout((t=this,function(){return t.editor.trigger("selectionchanged")}),0);var t},t.prototype._onKeyDown=function(r){var t,e,i,o,n;if(!1===this.editor.triggerHandler(r))return!1;if(!this.hotkeys.respondTo(r)){if(r.which in this._keystrokeHandlers){if(o="function"==typeof(t=this._keystrokeHandlers[r.which])["*"]?t["*"](r):void 0)return this.editor.trigger("valuechanged"),!1;if(this.editor.util.traverseUp((n=this,function(t){var e,i;if(t.nodeType===document.ELEMENT_NODE)return e=null!=(i=n._keystrokeHandlers[r.which])?i[t.tagName.toLowerCase()]:void 0,!0!==(o="function"==typeof e?e(r,A(t)):void 0)&&!1!==o&&void 0})),o)return this.editor.trigger("valuechanged"),!1}if(e=r.which,!(0<=K.call(this._modifierKeys,e)||(i=r.which,0<=K.call(this._arrowKeys,i))||this.editor.util.metaKey(r)&&86===r.which))return this.editor.util.support.oninput||this.throttledTrigger("valuechanged",["typing"]),null}},t.prototype._onKeyPress=function(t){return!1!==this.editor.triggerHandler(t)&&void 0},t.prototype._onKeyUp=function(t){var e,i;return!1!==this.editor.triggerHandler(t)&&(!this.editor.util.support.onselectionchange&&(i=t.which,0<=K.call(this._arrowKeys,i))?void this.editor.trigger("selectionchanged"):void(8!==t.which&&46!==t.which||!this.editor.util.isEmptyNode(this.editor.body)||(this.editor.body.empty(),e=A("<p/>").append(this.editor.util.phBr).appendTo(this.editor.body),this.editor.selection.setRangeAtStartOf(e))))},t.prototype._onPaste=function(t){var x,T,e,i,r,o,k,n,C,s,E;if(!1===this.editor.triggerHandler(t))return!1;if((k=this.editor.selection.deleteRangeContents()).collapsed||k.collapse(!0),x=this.editor.util.closestBlockEl(),T=x.is("pre, table"),t.originalEvent.clipboardData&&t.originalEvent.clipboardData.items&&0<t.originalEvent.clipboardData.items.length&&(r=t.originalEvent.clipboardData.items[0],/^image\//.test(r.type)&&!T)){if(null==(e=r.getAsFile())||!this.opts.pasteImage)return;return e.name||(e.name="Clipboard Image.png"),(C={})[this.opts.pasteImage]=!0,null!=(n=this.editor.uploader)&&n.upload(e,C),!1}return E=this,o=function(t){var e,i,r,o,n,s,a,l,d,u,p,h,c,f,g,m,v,y,b,_,w;if(!1!==E.editor.triggerHandler("pasting",[t])&&t){if(T)if(x.is("table")){for(l=(g=t.split("\n")).pop(),n=0,d=g.length;n<d;n++)f=g[n],E.editor.selection.insertNode(document.createTextNode(f)),E.editor.selection.insertNode(A("<br/>"));E.editor.selection.insertNode(document.createTextNode(l))}else for(s=0,u=(b=(t=A("<div/>").text(t)).contents()).length;s<u;s++)v=b[s],E.editor.selection.insertNode(A(v)[0],k);else if(x.is(E.editor.body))for(a=0,p=t.length;a<p;a++)v=t[a],E.editor.selection.insertNode(v,k);else{if(t.length<1)return;if(1===t.length)if(t.is("p")){if(1===(r=t.contents()).length&&r.is("img")){if(e=r,/^data:image/.test(e.attr("src"))){if(!E.opts.pasteImage)return;return(i=E.editor.util.dataURLtoBlob(e.attr("src"))).name="Clipboard Image.png",(C={})[E.opts.pasteImage]=!0,void(null!=(_=E.editor.uploader)&&_.upload(i,C))}if(e.is('img[src^="webkit-fake-url://"]'))return}for(m=0,h=r.length;m<h;m++)v=r[m],E.editor.selection.insertNode(v,k)}else if(x.is("p")&&E.editor.util.isEmptyNode(x))x.replaceWith(t),E.editor.selection.setRangeAtEndOf(t,k);else if(t.is("ul, ol"))if(1===t.find("li").length)for(y=0,c=(w=(t=A("<div/>").text(t.text())).contents()).length;y<c;y++)v=w[y],E.editor.selection.insertNode(A(v)[0],k);else x.is("li")?x.parent().after(t):x.after(t),E.editor.selection.setRangeAtEndOf(t,k);else x.after(t),E.editor.selection.setRangeAtEndOf(t,k);else x.is("li")&&(x=x.parent()),E.editor.selection.rangeAtStartOf(x,k)?o="before":E.editor.selection.rangeAtEndOf(x,k)?o="after":(E.editor.selection.breakBlockEl(x,k),o="before"),x[o](t),E.editor.selection.setRangeAtEndOf(t.last(),k)}return E.editor.trigger("valuechanged")}},T?(t.preventDefault(),i=this.editor.util.browser.msie?window.clipboardData.getData("Text"):t.originalEvent.clipboardData.getData("text/plain"),o(i)):(this.editor.selection.save(k),this._pasteArea.focus(),this.editor.util.browser.msie&&10===this.editor.util.browser.version&&(t.preventDefault(),this._pasteArea.html(window.clipboardData.getData("Text"))),setTimeout((s=this,function(){return s._pasteArea.is(":empty")?i=null:((i=A("<div/>").append(s._pasteArea.contents())).find("table colgroup").remove(),s.editor.formatter.format(i),s.editor.formatter.decorate(i),s.editor.formatter.beautify(i.children()),i=i.contents()),s._pasteArea.empty(),k=s.editor.selection.restore(),o(i)}),10))},t.prototype._onDrop=function(t){return!1!==this.editor.triggerHandler(t)&&setTimeout((e=this,function(){return e.editor.trigger("valuechanged")}),0);var e},t.prototype._onInput=function(){return this.throttledTrigger("valuechanged",["oninput"])},t.prototype.addKeystrokeHandler=function(t,e,i){return this._keystrokeHandlers[t]||(this._keystrokeHandlers[t]={}),this._keystrokeHandlers[t][e]=i},t.prototype.addShortcut=function(t,e){return this.hotkeys.add(t,A.proxy(e,this))},t}(),v=function(){function t(){return t.__super__.constructor.apply(this,arguments)}return D(t,p),t.pluginName="Keystroke",t.prototype._init=function(){var t,o,n,u,s,a,l,r,d,p;return this.editor=this._module,this.editor.util.browser.safari&&this.editor.inputManager.addKeystrokeHandler("13","*",(p=this,function(t){var e,i;if(t.shiftKey&&!(e=p.editor.util.closestBlockEl()).is("pre"))return i=A("<br/>"),p.editor.selection.rangeAtEndOf(e)?(p.editor.selection.insertNode(i),p.editor.selection.insertNode(A("<br/>")),p.editor.selection.setRangeBefore(i)):p.editor.selection.insertNode(i),!0})),(this.editor.util.browser.webkit||this.editor.util.browser.msie)&&(t=function(t,e){var i;if(d.editor.selection.rangeAtEndOf(e))return i=A("<p/>").append(d.editor.util.phBr).insertAfter(e),d.editor.selection.setRangeAtStartOf(i),!0},(d=this).editor.inputManager.addKeystrokeHandler("13","h1",t),this.editor.inputManager.addKeystrokeHandler("13","h2",t),this.editor.inputManager.addKeystrokeHandler("13","h3",t),this.editor.inputManager.addKeystrokeHandler("13","h4",t),this.editor.inputManager.addKeystrokeHandler("13","h5",t),this.editor.inputManager.addKeystrokeHandler("13","h6",t)),this.editor.inputManager.addKeystrokeHandler("8","*",(r=this,function(){var t,e,i;return(e=(i=r.editor.util.furthestBlockEl()).prev()).is("hr")&&r.editor.selection.rangeAtStartOf(i)?(r.editor.selection.save(),e.remove(),r.editor.selection.restore(),!0):(t=r.editor.util.closestBlockEl(),r.editor.util.browser.webkit&&r.editor.selection.rangeAtStartOf(t)?(r.editor.selection.save(),r.editor.formatter.cleanNode(t,!0),r.editor.selection.restore(),null):void 0)})),this.editor.inputManager.addKeystrokeHandler("13","li",(l=this,function(t,e){var i,r,o,n;if((i=e.clone()).find("ul, ol").remove(),l.editor.util.isEmptyNode(i)&&e.is(l.editor.util.closestBlockEl())){if(r=e.parent(),0<e.next("li").length){if(!l.editor.util.isEmptyNode(e))return;0<r.parent("li").length?(o=A("<li/>").append(l.editor.util.phBr).insertAfter(r.parent("li")),n=A("<"+r[0].tagName+"/>").append(e.nextAll("li")),o.append(n)):(o=A("<p/>").append(l.editor.util.phBr).insertAfter(r),n=A("<"+r[0].tagName+"/>").append(e.nextAll("li")),o.after(n))}else 0<r.parent("li").length?(o=A("<li/>").insertAfter(r.parent("li"))).append(0<e.contents().length?e.contents():l.editor.util.phBr):(o=A("<p/>").append(l.editor.util.phBr).insertAfter(r),0<e.children("ul, ol").length&&o.after(e.children("ul, ol")));return e.prev("li").length?e.remove():r.remove(),l.editor.selection.setRangeAtStartOf(o),!0}})),this.editor.inputManager.addKeystrokeHandler("13","pre",(a=this,function(t,e){var i,r,o;return t.preventDefault(),t.shiftKey?(i=A("<p/>").append(a.editor.util.phBr).insertAfter(e),a.editor.selection.setRangeAtStartOf(i)):(r=null,(o=a.editor.selection.getRange()).deleteContents(),!a.editor.util.browser.msie&&a.editor.selection.rangeAtEndOf(e)?(r=document.createTextNode("\n\n"),o.insertNode(r),o.setEnd(r,1)):(r=document.createTextNode("\n"),o.insertNode(r),o.setStartAfter(r)),o.collapse(!1),a.editor.selection.selectRange(o)),!0})),this.editor.inputManager.addKeystrokeHandler("13","blockquote",(s=this,function(t,e){var i,r;return(i=s.editor.util.closestBlockEl()).is("p")&&!i.next().length&&s.editor.util.isEmptyNode(i)?(e.after(i),r=document.createRange(),s.editor.selection.setRangeAtStartOf(i,r),!0):void 0})),this.editor.inputManager.addKeystrokeHandler("8","li",(u=this,function(t,e){var i,r,o,n,s,a,l,d;return r=e.children("ul, ol"),s=e.prev("li"),0<r.length&&0<s.length&&(d="",a=null,e.contents().each(function(t,e){return(1!==e.nodeType||!/UL|OL/.test(e.nodeName))&&(1===e.nodeType&&/BR/.test(e.nodeName)?void 0:(3===e.nodeType&&e.nodeValue?d+=e.nodeValue:1===e.nodeType&&(d+=A(e).text()),a=A(e)))}),a&&1===d.length&&u.editor.util.browser.firefox&&!a.next("br").length?(i=A(u.editor.util.phBr).insertAfter(a),a.remove(),u.editor.selection.setRangeBefore(i),!0):!(0<d.length||(l=document.createRange(),0<(n=s.children("ul, ol")).length?(o=A("<li/>").append(u.editor.util.phBr).appendTo(n),n.append(r.children("li")),e.remove(),u.editor.selection.setRangeAtEndOf(o,l)):(u.editor.selection.setRangeAtEndOf(s,l),s.append(r),e.remove(),u.editor.selection.selectRange(l)),0)))})),this.editor.inputManager.addKeystrokeHandler("8","pre",(n=this,function(t,e){var i,r,o;if(n.editor.selection.rangeAtStartOf(e))return r=e.html().replace("\n","<br/>"),i=A("<p/>").append(r||n.editor.util.phBr).insertAfter(e),e.remove(),o=document.createRange(),n.editor.selection.setRangeAtStartOf(i,o),!0})),this.editor.inputManager.addKeystrokeHandler("8","blockquote",(o=this,function(t,e){var i,r;if(o.editor.selection.rangeAtStartOf(e))return i=e.children().first().unwrap(),r=document.createRange(),o.editor.selection.setRangeAtStartOf(i,r),!0}))},t}(),O=function(){function t(){return t.__super__.constructor.apply(this,arguments)}return D(t,p),t.pluginName="UndoManager",t.prototype._index=-1,t.prototype._capacity=50,t.prototype._timer=null,t.prototype._init=function(){var t,e,i,r,o;return this.editor=this._module,this._stack=[],this.editor.util.os.mac?(e="cmd+z",t="shift+cmd+z"):this.editor.util.os.win?(e="ctrl+z",t="ctrl+y"):(e="ctrl+z",t="shift+ctrl+z"),this.editor.inputManager.addShortcut(e,(o=this,function(t){return t.preventDefault(),o.undo(),!1})),this.editor.inputManager.addShortcut(t,(r=this,function(t){return t.preventDefault(),r.redo(),!1})),this.editor.on("valuechanged",(i=this,function(t,e){return"undo"!==e&&"redo"!==e?(i._timer&&(clearTimeout(i._timer),i._timer=null),i._timer=setTimeout(function(){return i._pushUndoState(),i._timer=null},200)):void 0}))},t.prototype._pushUndoState=function(){var t,e;if(!1!==this.editor.triggerHandler("pushundostate")&&(t=this.currentState(),e=this.editor.body.html(),!t||t.html!==e))return this._index+=1,this._stack.length=this._index,this._stack.push({html:e,caret:this.caretPosition()}),this._stack.length>this._capacity?(this._stack.shift(),this._index-=1):void 0},t.prototype.currentState=function(){return this._stack.length&&-1<this._index?this._stack[this._index]:null},t.prototype.undo=function(){var t;if(!(this._index<1||this._stack.length<2))return this.editor.hidePopover(),this._index-=1,t=this._stack[this._index],this.editor.body.html(t.html),this.caretPosition(t.caret),this.editor.body.find(".selected").removeClass("selected"),this.editor.sync(),this.editor.trigger("valuechanged",["undo"])},t.prototype.redo=function(){var t;if(!(this._index<0||this._stack.length<this._index+2))return this.editor.hidePopover(),this._index+=1,t=this._stack[this._index],this.editor.body.html(t.html),this.caretPosition(t.caret),this.editor.body.find(".selected").removeClass("selected"),this.editor.sync(),this.editor.trigger("valuechanged",["redo"])},t.prototype.update=function(){var t,e;if(!this._timer&&(t=this.currentState()))return e=this.editor.body.html(),t.html=e,t.caret=this.caretPosition()},t.prototype._getNodeOffset=function(i,r){var t,o,n;return t=r?A(i):A(i).parent(),n=0,o=!1,t.contents().each(function(t,e){return r!==t&&i!==e&&(3===e.nodeType?o||(n+=1,o=!0):(n+=1,o=!1),null)}),n},t.prototype._getNodePosition=function(t,e){var i,r,o;if(3===t.nodeType)for(r=t.previousSibling;r&&3===r.nodeType;)t=r,e+=this.editor.util.getNodeLength(r),r=r.previousSibling;else e=this._getNodeOffset(t,e);return(i=[]).unshift(e),this.editor.util.traverseUp((o=this,function(t){return i.unshift(o._getNodeOffset(t))}),t),i},t.prototype._getNodeByPosition=function(t){var e,i,r,o,n,s,a,l;for(s=this.editor.body[0],r=o=0,n=(l=t.slice(0,t.length-1)).length;o<n;r=++o){if((a=l[r])>(i=s.childNodes).length-1){if(r!==t.length-2||!A(s).is("pre")){s=null;break}e=document.createTextNode(""),s.appendChild(e),i=s.childNodes}s=i[a]}return s},t.prototype.caretPosition=function(t){var e,i,r,o,n;if(t){if(this.editor.inputManager.focused||this.editor.body.focus(),!t.start)return void this.editor.body.blur();if(o=this._getNodeByPosition(t.start),n=t.start[t.start.length-1],t.collapsed?(e=o,i=n):(e=this._getNodeByPosition(t.end),i=t.start[t.start.length-1]),!o||!e)throw new Error("simditor: invalid caret state");return(r=document.createRange()).setStart(o,n),r.setEnd(e,i),this.editor.selection.selectRange(r)}return r=this.editor.selection.getRange(),this.editor.inputManager.focused&&null!=r?((t={start:[],end:null,collapsed:!0}).start=this._getNodePosition(r.startContainer,r.startOffset),r.collapsed||(t.end=this._getNodePosition(r.endContainer,r.endOffset),t.collapsed=!1),t):{}},t}(),H=function(){function e(){return e.__super__.constructor.apply(this,arguments)}return D(e,p),e.pluginName="Util",e.prototype._init=function(){return this.editor=this._module,this.browser.msie&&this.browser.version<11?this.phBr="":void 0},e.prototype.phBr="<br/>",e.prototype.os=(u={},/Mac/.test(navigator.appVersion)?u.mac=!0:/Linux/.test(navigator.appVersion)?u.linux=!0:/Win/.test(navigator.appVersion)?u.win=!0:/X11/.test(navigator.appVersion)&&(u.unix=!0),/Mobi/.test(navigator.appVersion)&&(u.mobile=!0),u),e.prototype.browser=(d=navigator.userAgent,r=/(msie|trident)/i.test(d),t=/chrome|crios/i.test(d),l=/safari/i.test(d)&&!t,i=/firefox/i.test(d),r?{msie:!0,version:1*(null!=(o=d.match(/(msie |rv:)(\d+(\.\d+)?)/i))?o[2]:void 0)}:t?{webkit:!0,chrome:!0,version:1*(null!=(n=d.match(/(?:chrome|crios)\/(\d+(\.\d+)?)/i))?n[1]:void 0)}:l?{webkit:!0,safari:!0,version:1*(null!=(s=d.match(/version\/(\d+(\.\d+)?)/i))?s[1]:void 0)}:i?{mozilla:!0,firefox:!0,version:1*(null!=(a=d.match(/firefox\/(\d+(\.\d+)?)/i))?a[1]:void 0)}:{}),e.prototype.support={onselectionchange:function(){var t;if(void 0!==(t=document.onselectionchange))try{return document.onselectionchange=0,null===document.onselectionchange}catch(e){}finally{document.onselectionchange=t}return!1}(),oninput:!/(msie|trident)/i.test(navigator.userAgent)},e.prototype.reflow=function(t){return null==t&&(t=document),A(t)[0].offsetHeight},e.prototype.metaKey=function(t){return/Mac/.test(navigator.userAgent)?t.metaKey:t.ctrlKey},e.prototype.isEmptyNode=function(t){var e;return(e=A(t)).is(":empty")||!e.text()&&!e.find(":not(br, span, div)").length},e.prototype.blockNodes=["div","p","ul","ol","li","blockquote","hr","pre","h1","h2","h3","h4","table"],e.prototype.isBlockNode=function(t){return!(!(t=A(t)[0])||3===t.nodeType)&&new RegExp("^("+this.blockNodes.join("|")+")$").test(t.nodeName.toLowerCase())},e.prototype.closestBlockEl=function(t){var e,i,r,o;return null==t&&(t=null!=(r=this.editor.selection.getRange())?r.commonAncestorContainer:void 0),(e=A(t)).length?(i=(i=e.parentsUntil(this.editor.body).addBack()).filter((o=this,function(t){return o.isBlockNode(i.eq(t))}))).length?i.last():null:null},e.prototype.furthestNode=function(t,i){var e,r,o;return null==t&&(t=null!=(o=this.editor.selection.getRange())?o.commonAncestorContainer:void 0),(e=A(t)).length?(r=(r=e.parentsUntil(this.editor.body).addBack()).filter(function(t){var e;return e=r.eq(t),A.isFunction(i)?i(e):e.is(i)})).length?r.first():null:null},e.prototype.furthestBlockEl=function(t){return this.furthestNode(t,A.proxy(this.isBlockNode,this))},e.prototype.getNodeLength=function(t){switch(t.nodeType){case 7:case 10:return 0;case 3:case 8:return t.length;default:return t.childNodes.length}},e.prototype.traverseUp=function(t,e){var i,r,o,n,s;if(null==e&&(e=null!=(n=this.editor.selection.getRange())?n.commonAncestorContainer:void 0),null==e||!A.contains(this.editor.body[0],e))return!1;for((o=A(e).parentsUntil(this.editor.body).get()).unshift(e),s=[],i=0,r=o.length;i<r&&!1!==t(o[i]);i++)s.push(void 0);return s},e.prototype.dataURLtoBlob=function(t){var e,i,r,o,n,s,a,l,d,u,p;if(n=(s=window.Blob&&function(){try{return Boolean(new Blob)}catch(e){return e,!1}}())&&window.Uint8Array&&function(){try{return 100===new Blob([new Uint8Array(100)]).size}catch(e){return e,!1}}(),e=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder,!((s||e)&&window.atob&&window.ArrayBuffer&&window.Uint8Array))return!1;for(o=0<=t.split(",")[0].indexOf("base64")?atob(t.split(",")[1]):decodeURIComponent(t.split(",")[1]),i=new ArrayBuffer(o.length),l=new Uint8Array(i),a=d=0,p=o.length;0<=p?d<=p:p<=d;a=0<=p?++d:--d)l[a]=o.charCodeAt(a);return u=t.split(",")[0].split(":")[1].split(";")[0],s?new Blob([n?l:i],{type:u}):((r=new e).append(i),r.getBlob(u))},e.prototype.throttle=function(o,n){var s,a,l;return s=null,a=0,l=function(){return s?(clearTimeout(s),s=null):void 0},function(){var t,e,i,r;return e=Date.now(),a||(a=e),r=null,0<(i=n-(e-a))&&i<n?(a=e,l(),t=arguments,s=setTimeout(function(){return a=0,s=null,r=o.apply(null,t)},n)):(l(),a!==e&&(a=0),r=o.apply(null,arguments)),r}},e.prototype.formatHTML=function(t){var e,i,r,o,n,s,a,l,d;for(s=/<(\/?)(.+?)(\/?)>/g,l="",o=0,r=null,i="  ",a=function(t,e){return new Array(e+1).join(t)};null!==(n=s.exec(t));)n.isBlockNode=-1<A.inArray(n[2],this.blockNodes),n.isStartTag="/"!==n[1]&&"/"!==n[3],n.isEndTag="/"===n[1]||"/"===n[3],e=r?r.index+r[0].length:0,0<(d=t.substring(e,n.index)).length&&A.trim(d)&&(l+=d),n.isBlockNode&&n.isEndTag&&!n.isStartTag&&(o-=1),n.isBlockNode&&n.isStartTag&&(r&&r.isBlockNode&&r.isEndTag||(l+="\n"),l+=a(i,o)),l+=n[0],n.isBlockNode&&n.isEndTag&&(l+="\n"),n.isBlockNode&&n.isStartTag&&(o+=1),r=n;return A.trim(l)},e;var t,i,r,o,n,s,a,l,d,u}(),S=function(){function t(){return t.__super__.constructor.apply(this,arguments)}return D(t,p),t.pluginName="Toolbar",t.prototype.opts={toolbar:!0,toolbarFloat:!0,toolbarHidden:!1,toolbarFloatOffset:0},t.prototype._tpl={wrapper:'<div class="simditor-toolbar"><ul></ul></div>',separator:'<li><span class="separator"></span></li>'},t.prototype._init=function(){var r,t,e,i,o,n,s,a;return this.editor=this._module,this.opts.toolbar?(A.isArray(this.opts.toolbar)||(this.opts.toolbar=["bold","italic","underline","strikethrough","|","ol","ul","blockquote","code","|","link","image","|","indent","outdent"]),this._render(),this.list.on("click",function(){return!1}),this.wrapper.on("mousedown",(a=this,function(){return a.list.find(".menu-on").removeClass(".menu-on")})),A(document).on("mousedown.simditor"+this.editor.id,(s=this,function(){return s.list.find(".menu-on").removeClass(".menu-on")})),!this.opts.toolbarHidden&&this.opts.toolbarFloat&&(this.wrapper.width(this.wrapper.outerWidth()),this.wrapper.css("top",this.opts.toolbarFloatOffset),r=this.wrapper.outerHeight(),this.editor.util.os.mobile||A(window).on("resize.simditor-"+this.editor.id,(n=this,function(){return n.wrapper.css("position","static"),n.editor.util.reflow(n.wrapper),n.wrapper.css("left",n.wrapper.offset().left),n.wrapper.css("position","")})).resize(),A(window).on("scroll.simditor-"+this.editor.id,(o=this,function(){var t,e,i;if(t=(i=o.editor.wrapper.offset().top)+o.editor.wrapper.outerHeight()-80,(e=A(document).scrollTop()+o.opts.toolbarFloatOffset)<=i||t<=e){if(o.editor.wrapper.removeClass("toolbar-floating").css("padding-top",""),o.editor.util.os.mobile)return o.wrapper.css("top",o.opts.toolbarFloatOffset)}else if(o.editor.wrapper.addClass("toolbar-floating").css("padding-top",r),o.editor.util.os.mobile)return o.wrapper.css("top",e-i+o.opts.toolbarFloatOffset)}))),
this.editor.on("selectionchanged",(i=this,function(){return i.toolbarStatus()})),this.editor.on("destroy",(e=this,function(){return e.buttons.length=0})),A(document).on("mousedown.simditor-"+this.editor.id,(t=this,function(){return t.list.find("li.menu-on").removeClass("menu-on")}))):void 0},t.prototype._render=function(){var t,e,i,r;for(this.buttons=[],this.wrapper=A(this._tpl.wrapper).prependTo(this.editor.wrapper),this.list=this.wrapper.find("ul"),t=0,e=(r=this.opts.toolbar).length;t<e;t++)if("|"!==(i=r[t])){if(!this.constructor.buttons[i])throw new Error('simditor: invalid toolbar button "'+i+'"');this.buttons.push(new this.constructor.buttons[i]({editor:this.editor}))}else A(this._tpl.separator).appendTo(this.list);return this.opts.toolbarHidden?this.wrapper.hide():this.editor.placeholderEl.css("top",this.wrapper.outerHeight())},t.prototype.toolbarStatus=function(l){var d;if(this.editor.inputManager.focused)return d=this.buttons.slice(0),this.editor.util.traverseUp(function(t){var e,i,r,o,n,s,a;for(a=[],i=r=0,n=d.length;r<n;i=++r)e=d[i],(null==l||e.name===l)&&(e.status&&!0!==e.status(A(t))||a.push(e));for(o=0,s=a.length;o<s;o++)e=a[o],i=A.inArray(e,d),d.splice(i,1);return 0!==d.length&&void 0})},t.prototype.findButton=function(t){var e;return null!=(e=this.list.find(".toolbar-item-"+t).data("button"))?e:null},t.addButton=function(t){return this.buttons[t.prototype.name]=t},t.buttons={},t}(),f=function(){function t(){return t.__super__.constructor.apply(this,arguments)}return D(t,p),t.pluginName="Indentation",t.prototype.opts={tabIndent:!0},t.prototype._init=function(){return this.editor=this._module,this.editor.inputManager.addKeystrokeHandler("9","*",(i=this,function(t){var e;return e=i.editor.toolbar.findButton("code"),i.opts.tabIndent||e&&e.active?i.indent(t.shiftKey):void 0}));var i},t.prototype.indent=function(i){var t,e,r,o,n,s;return(o=this.editor.selection.getRange())?(r=this.editor.util.closestBlockEl(o.startContainer),e=this.editor.util.closestBlockEl(o.endContainer),r.is("li")&&e.is("li")&&r.parent().is(e.parent())||(r=this.editor.util.furthestBlockEl(r),e=this.editor.util.furthestBlockEl(e)),t=r.is(e)?r:r.nextUntil(e).add(r).add(e),n=!1,t.each((s=this,function(t,e){return n=i?s.outdentBlock(e):s.indentBlock(e)})),n):void 0},t.prototype.indentBlock=function(t){var e,i,r,o,n,s,a,l,d;if((e=A(t)).length){if(e.is("pre")){if(l=this.editor.selection.getRange(),!(n=A(l.commonAncestorContainer)).is(e)&&!n.closest("pre").is(e))return;this.indentText(l)}else if(e.is("li")){if((o=e.prev("li")).length<1)return;this.editor.selection.save(),d=e.parent()[0].tagName,0<(i=o.children("ul, ol")).length?i.append(e):A("<"+d+"/>").append(e).appendTo(o),this.editor.selection.restore()}else if(e.is("p, h1, h2, h3, h4"))a=e.attr("data-indent")||0,a=Math.min(1*a+1,10),e.attr("data-indent",a);else if(e.is("table")||e.is(".simditor-table")){if(l=this.editor.selection.getRange(),0<(r=(s=A(l.commonAncestorContainer).closest("td")).next("td")).length||(r=s.parent("tr").next("tr").find("td:first")),!(0<s.length&&0<r.length))return!1;this.editor.selection.setRangeAtEndOf(r)}return!0}},t.prototype.indentText=function(t){var e,i;return e=t.toString().replace(/^(?=.+)/gm,"\xa0\xa0"),i=document.createTextNode(e||"\xa0\xa0"),t.deleteContents(),t.insertNode(i),e?(t.selectNode(i),this.editor.selection.selectRange(t)):this.editor.selection.setRangeAfter(i)},t.prototype.outdentBlock=function(t){var e,i,r,o,n,s,a,l,d,u;if((e=A(t))&&0<e.length){if(e.is("pre")){if(d=this.editor.selection.getRange(),!(o=A(d.commonAncestorContainer)).is(e)&&!o.closest("pre").is(e))return;this.outdentText(d)}else if(e.is("li")){if((r=(i=e.parent()).parent("li")).length<1)return void(null!=(a=this.editor.toolbar.findButton(i[0].tagName.toLowerCase()))&&a.command());this.editor.selection.save(),0<e.next("li").length&&A("<"+i[0].tagName+"/>").append(e.nextAll("li")).appendTo(e),e.insertAfter(r),i.children("li").length<1&&i.remove(),this.editor.selection.restore()}else if(e.is("p, h1, h2, h3, h4"))(l=1*(l=null!=(u=e.attr("data-indent"))?u:0)-1)<0&&(l=0),e.attr("data-indent",l);else if(e.is("table")||e.is(".simditor-table")){if(d=this.editor.selection.getRange(),0<(n=(s=A(d.commonAncestorContainer).closest("td")).prev("td")).length||(n=s.parent("tr").prev("tr").find("td:last")),!(0<s.length&&0<n.length))return;this.editor.selection.setRangeAtEndOf(n)}return!0}},t.prototype.outdentText=function(){},t}(),(C=function(){function s(){return s.__super__.constructor.apply(this,arguments)}return D(s,p),s.connect(H),s.connect(g),s.connect(O),s.connect(v),s.connect(i),s.connect(k),s.connect(S),s.connect(f),s.count=0,s.prototype.opts={textarea:null,placeholder:"",defaultImage:"images/image.png",params:{},upload:!1},s.prototype._init=function(){var t,e,i,r,o,n;if(this.textarea=A(this.opts.textarea),this.opts.placeholder=this.opts.placeholder||this.textarea.attr("placeholder"),!this.textarea.length)throw new Error("simditor: param textarea is required.");if(null!=(t=this.textarea.data("simditor"))&&t.destroy(),this.id=++s.count,this._render(),this.opts.upload&&a&&(i="object"==typeof this.opts.upload?this.opts.upload:{},this.uploader=a(i)),(e=this.textarea.closest("form")).length&&(e.on("submit.simditor-"+this.id,(n=this,function(){return n.sync()})),e.on("reset.simditor-"+this.id,(o=this,function(){return o.setValue("")}))),this.on("initialized",(r=this,function(){return r.opts.placeholder&&r.on("valuechanged",function(){return r._placeholder()}),r.setValue(r.textarea.val().trim()||"")})),this.util.browser.mozilla){this.util.reflow();try{return document.execCommand("enableObjectResizing",!1,!1),document.execCommand("enableInlineTableEditing",!1,!1)}catch(l){l}}},s.prototype._tpl='<div class="simditor">\n  <div class="simditor-wrapper">\n    <div class="simditor-placeholder"></div>\n    <div class="simditor-body" contenteditable="true">\n    </div>\n  </div>\n</div>',s.prototype._render=function(){var t,e,i,r;if(this.el=A(this._tpl).insertBefore(this.textarea),this.wrapper=this.el.find(".simditor-wrapper"),this.body=this.wrapper.find(".simditor-body"),this.placeholderEl=this.wrapper.find(".simditor-placeholder").append(this.opts.placeholder),this.el.data("simditor",this),this.wrapper.append(this.textarea),this.textarea.data("simditor",this).blur(),this.body.attr("tabindex",this.textarea.attr("tabindex")),this.util.os.mac?this.el.addClass("simditor-mac"):this.util.os.linux&&this.el.addClass("simditor-linux"),this.util.os.mobile&&this.el.addClass("simditor-mobile"),this.opts.params){for(t in i=[],e=this.opts.params)r=e[t],i.push(A("<input/>",{type:"hidden",name:t,value:r}).insertAfter(this.textarea));return i}},s.prototype._placeholder=function(){var t,e;return 0===(t=this.body.children()).length||1===t.length&&this.util.isEmptyNode(t)&&(null!=(e=t.data("indent"))?e:0)<1?this.placeholderEl.show():this.placeholderEl.hide()},s.prototype.setValue=function(t){return this.hidePopover(),this.textarea.val(t),this.body.html(t),this.formatter.format(),this.formatter.decorate(),this.util.reflow(this.body),this.inputManager.lastCaretPosition=null,this.trigger("valuechanged")},s.prototype.getValue=function(){return this.sync()},s.prototype.sync=function(){var t,e,i,r,o,n;for(e=this.body.clone(),this.formatter.undecorate(e),this.formatter.format(e),this.formatter.autolink(e),o=(t=e.children()).last("p"),r=t.first("p");o.is("p")&&this.util.isEmptyNode(o);)o=(i=o).prev("p"),i.remove();for(;r.is("p")&&this.util.isEmptyNode(r);)i=r,r=o.next("p"),i.remove();return e.find("img.uploading").remove(),n=A.trim(e.html()),this.textarea.val(n),n},s.prototype.focus=function(){var t,e;return this.sourceMode?void this.textarea.focus():this.inputManager.lastCaretPosition?this.undoManager.caretPosition(this.inputManager.lastCaretPosition):(0<(t=this.body.find("p").last()).length||(t=A("<p/>").append(this.util.phBr).appendTo(this.body)),e=document.createRange(),this.selection.setRangeAtEndOf(t,e),this.body.focus())},s.prototype.blur=function(){return this.sourceMode?this.textarea.blur():this.body.blur()},s.prototype.hidePopover=function(){return this.el.find(".simditor-popover").each(function(t,e){return(e=A(e).data("popover")).active?e.hide():void 0})},s.prototype.destroy=function(){return this.triggerHandler("destroy"),this.textarea.closest("form").off(".simditor .simditor-"+this.id),this.selection.clear(),this.inputManager.focused=!1,this.textarea.insertBefore(this.el).hide().val("").removeData("simditor"),this.el.remove(),A(document).off(".simditor-"+this.id),A(window).off(".simditor-"+this.id),this.off()},s}()).i18n={"zh-CN":{blockquote:"\u5f15\u7528",bold:"\u52a0\u7c97\u6587\u5b57",code:"\u63d2\u5165\u4ee3\u7801",color:"\u6587\u5b57\u989c\u8272",hr:"\u5206\u9694\u7ebf",image:"\u63d2\u5165\u56fe\u7247",externalImage:"\u5916\u94fe\u56fe\u7247",uploadImage:"\u4e0a\u4f20\u56fe\u7247",uploadFailed:"\u4e0a\u4f20\u5931\u8d25\u4e86",uploadError:"\u4e0a\u4f20\u51fa\u9519\u4e86",imageUrl:"\u56fe\u7247\u5730\u5740",imageSize:"\u56fe\u7247\u5c3a\u5bf8",imageAlt:"\u56fe\u7247\u63cf\u8ff0",restoreImageSize:"\u8fd8\u539f\u56fe\u7247\u5c3a\u5bf8",uploading:"\u6b63\u5728\u4e0a\u4f20",indent:"\u5411\u53f3\u7f29\u8fdb",outdent:"\u5411\u5de6\u7f29\u8fdb",italic:"\u659c\u4f53\u6587\u5b57",link:"\u63d2\u5165\u94fe\u63a5",text:"\u6587\u672c",linkText:"\u94fe\u63a5\u6587\u5b57",linkUrl:"\u5730\u5740",removeLink:"\u79fb\u9664\u94fe\u63a5",ol:"\u6709\u5e8f\u5217\u8868",ul:"\u65e0\u5e8f\u5217\u8868",strikethrough:"\u5220\u9664\u7ebf\u6587\u5b57",table:"\u8868\u683c",deleteRow:"\u5220\u9664\u884c",insertRowAbove:"\u5728\u4e0a\u9762\u63d2\u5165\u884c",insertRowBelow:"\u5728\u4e0b\u9762\u63d2\u5165\u884c",deleteColumn:"\u5220\u9664\u5217",insertColumnLeft:"\u5728\u5de6\u8fb9\u63d2\u5165\u5217",insertColumnRight:"\u5728\u53f3\u8fb9\u63d2\u5165\u5217",deleteTable:"\u5220\u9664\u8868\u683c",title:"\u6807\u9898",source:"HTML\u6e90\u4ee3\u7801",normalText:"\u666e\u901a\u6587\u672c",underline:"\u4e0b\u5212\u7ebf\u6587\u5b57"}},n=function(){function r(t){this.editor=t.editor,this.title=this._t(this.name),r.__super__.constructor.call(this,t)}return D(r,p),r.prototype._tpl={item:'<li><a tabindex="-1" unselectable="on" class="toolbar-item" href="javascript:;"><span></span></a></li>',menuWrapper:'<div class="toolbar-menu"></div>',menuItem:'<li><a tabindex="-1" unselectable="on" class="menu-item" href="javascript:;"><span></span></a></li>',separator:'<li><span class="separator"></span></li>'},r.prototype.name="",r.prototype.icon="",r.prototype.title="",r.prototype.text="",r.prototype.htmlTag="",r.prototype.disableTag="",r.prototype.menu=!1,r.prototype.active=!1,r.prototype.disabled=!1,r.prototype.needFocus=!0,r.prototype.shortcut=null,r.prototype._init=function(){var t,e,i,r,o;for(this.render(),this.el.on("mousedown",function(i){return function(t){var e;return t.preventDefault(),i.el.hasClass("disabled")||i.needFocus&&!i.editor.inputManager.focused||(i.menu?(i.wrapper.toggleClass("menu-on").siblings("li").removeClass("menu-on"),i.wrapper.is(".menu-on")&&(0<i.menuWrapper.offset().left+i.menuWrapper.outerWidth()+5-i.editor.wrapper.offset().left-i.editor.wrapper.outerWidth()&&i.menuWrapper.css({left:"auto",right:0}),i.trigger("menuexpand"))):(e=i.el.data("param"),i.command(e))),!1}}(this)),this.wrapper.on("click","a.menu-item",function(r){return function(t){var e,i;return t.preventDefault(),e=A(t.currentTarget),r.wrapper.removeClass("menu-on"),e.hasClass("disabled")||r.needFocus&&!r.editor.inputManager.focused||(r.editor.toolbar.wrapper.removeClass("menu-on"),i=e.data("param"),r.command(i)),!1}}(this)),this.wrapper.on("mousedown","a.menu-item",function(){return!1}),this.editor.on("blur",function(t){return function(){return t.editor.sourceMode?void 0:(t.setActive(!1),t.setDisabled(!1))}}(this)),null!=this.shortcut&&this.editor.inputManager.addShortcut(this.shortcut,function(t){return function(){return t.el.mousedown(),!1}}(this)),r=[],t=0,e=(i=this.htmlTag.split(",")).length;t<e;t++)o=i[t],o=A.trim(o),r.push(o&&A.inArray(o,this.editor.formatter._allowedTags)<0?this.editor.formatter._allowedTags.push(o):void 0);return r},r.prototype.render=function(){return this.wrapper=A(this._tpl.item).appendTo(this.editor.toolbar.list),this.el=this.wrapper.find("a.toolbar-item"),this.el.attr("title",this.title).addClass("toolbar-item-"+this.name).data("button",this),this.el.find("span").addClass(this.icon?"simditor-icon simditor-icon-"+this.icon:"").text(this.text),this.menu?(this.menuWrapper=A(this._tpl.menuWrapper).appendTo(this.wrapper),this.menuWrapper.addClass("toolbar-menu-"+this.name),this.renderMenu()):void 0},r.prototype.renderMenu=function(){var t,e,i,r,o,n,s;if(A.isArray(this.menu)){for(this.menuEl=A("<ul/>").appendTo(this.menuWrapper),s=[],e=0,i=(o=this.menu).length;e<i;e++)"|"!==(r=o[e])?(t=A(this._tpl.menuItem).appendTo(this.menuEl),s.push(t.find("a.menu-item").attr({title:null!=(n=r.title)?n:r.text,"data-param":r.param}).addClass("menu-item-"+r.name).find("span").text(r.text))):A(this._tpl.separator).appendTo(this.menuEl);return s}},r.prototype.setActive=function(t){return t!==this.active?(this.active=t,this.el.toggleClass("active",this.active),this.editor.toolbar.trigger("buttonstatus",[this])):void 0},r.prototype.setDisabled=function(t){return t!==this.disabled?(this.disabled=t,this.el.toggleClass("disabled",this.disabled),this.editor.toolbar.trigger("buttonstatus",[this])):void 0},r.prototype.status=function(t){return null!=t&&this.setDisabled(t.is(this.disableTag)),!!this.disabled||(null!=t&&this.setActive(t.is(this.htmlTag)),this.active)},r.prototype.command=function(){},r.prototype._t=function(){var t,e,i;return t=1<=arguments.length?P.call(arguments,0):[],(i=r.__super__._t.apply(this,t))||(i=(e=this.editor)._t.apply(e,t)),i},r}(),C.Button=n,T=function(){function r(t){this.button=t.button,this.editor=t.button.editor,r.__super__.constructor.call(this,t)}return D(r,p),r.prototype.offset={top:4,left:0},r.prototype.target=null,r.prototype.active=!1,r.prototype._init=function(){return this.el=A('<div class="simditor-popover"></div>').appendTo(this.editor.el).data("popover",this),this.render(),this.el.on("mouseenter",(e=this,function(){return e.el.addClass("hover")})),this.el.on("mouseleave",(t=this,function(){return t.el.removeClass("hover")}));var t,e},r.prototype.render=function(){},r.prototype.show=function(t,e){return null==e&&(e="bottom"),null!=t?(this.el.siblings(".simditor-popover").each(function(t,e){return(e=A(e).data("popover")).active?e.hide():void 0}),this.target=t.addClass("selected"),this.active?(this.refresh(e),this.trigger("popovershow")):(this.active=!0,this.el.css({left:-9999}).show(),setTimeout((i=this,function(){return i.refresh(e),i.trigger("popovershow")}),0))):void 0;var i},r.prototype.hide=function(){return this.active?(this.target&&this.target.removeClass("selected"),this.target=null,this.active=!1,this.el.hide(),this.trigger("popoverhide")):void 0},r.prototype.refresh=function(t){var e,i,r,o,n;return null==t&&(t="bottom"),this.active?(e=this.editor.el.offset(),o=this.target.offset(),r=this.target.outerHeight(),"bottom"===t?n=o.top-e.top+r:"top"===t&&(n=o.top-e.top-this.el.height()),i=Math.min(o.left-e.left,this.editor.wrapper.width()-this.el.outerWidth()-10),this.el.css({top:n+this.offset.top,left:i+this.offset.left})):void 0},r.prototype.destroy=function(){return this.target=null,this.active=!1,this.editor.off(".linkpopover"),this.el.remove()},r.prototype._t=function(){var t,e,i;return t=1<=arguments.length?P.call(arguments,0):[],(i=r.__super__._t.apply(this,t))||(i=(e=this.button)._t.apply(e,t)),i},r}(),C.Popover=T,E=function(){function r(){return r.__super__.constructor.apply(this,arguments)}return D(r,n),r.prototype.name="source",r.prototype.icon="html5",r.prototype.needFocus=!1,r.prototype._init=function(){return r.__super__._init.call(this),this.editor.textarea.on("focus",(i=this,function(){return i.editor.el.addClass("focus").removeClass("error")})),this.editor.textarea.on("blur",(e=this,function(){return e.editor.el.removeClass("focus"),e.editor.setValue(e.editor.textarea.val())})),this.editor.textarea.on("input",(t=this,function(){return t._resizeTextarea()}));var t,e,i},r.prototype.status=function(){return!0},r.prototype.command=function(){var t,e,i,r;for(this.editor.blur(),this.editor.el.toggleClass("simditor-source-mode"),this.editor.sourceMode=this.editor.el.hasClass("simditor-source-mode"),this.editor.sourceMode&&(this.editor.hidePopover(),this.editor.textarea.val(this.editor.util.formatHTML(this.editor.textarea.val())),this._resizeTextarea()),e=0,i=(r=this.editor.toolbar.buttons).length;e<i;e++)"source"===(t=r[e]).name?t.setActive(this.editor.sourceMode):t.setDisabled(this.editor.sourceMode);return null},r.prototype._resizeTextarea=function(){return this._textareaPadding||(this._textareaPadding=this.editor.textarea.innerHeight()-this.editor.textarea.height()),this.editor.textarea.height(0).height(this.editor.textarea[0].scrollHeight-this._textareaPadding)},r}(),C.Toolbar.addButton(E),N=function(){function i(){return i.__super__.constructor.apply(this,arguments)}return D(i,n),i.prototype.name="title",i.prototype.htmlTag="h1, h2, h3, h4",i.prototype.disableTag="pre, table",i.prototype._init=function(){return this.menu=[{name:"normal",text:this._t("normalText"),param:"p"},"|",{name:"h1",text:this._t("title")+" 1",param:"h1"},{name:"h2",text:this._t("title")+" 2",param:"h2"},{name:"h3",text:this._t("title")+" 3",param:"h3"},{name:"h4",text:this._t("title")+" 4",param:"h4"},{name:"h5",text:this._t("title")+" 5",param:"h5"}],i.__super__._init.call(this)},i.prototype.setActive=function(t,e){return i.__super__.setActive.call(this,t),this.el.removeClass("active-p active-h1 active-h2 active-h3"),t?this.el.addClass("active active-"+e):void 0},i.prototype.status=function(t){var e,i;return null!=t&&this.setDisabled(t.is(this.disableTag)),!!this.disabled||(null!=t&&(e=null!=(i=t[0].tagName)?i.toLowerCase():void 0,this.setActive(t.is(this.htmlTag),e)),this.active)},i.prototype.command=function(l){var t,e,i,r,o,n,s,a,d,u,p;for(p=(a=this.editor.selection.getRange()).startContainer,r=a.endContainer,i=this.editor.util.closestBlockEl(p),e=this.editor.util.closestBlockEl(r),this.editor.selection.save(),a.setStartBefore(i[0]),a.setEndAfter(e[0]),t=A(a.extractContents()),u=[],t.children().each(function(a){return function(t,e){var i,r,o,n,s;for(s=[],o=0,n=(r=a._convertEl(e,l)).length;o<n;o++)i=r[o],s.push(u.push(i));return s}}(this)),o=0,n=(d=u.reverse()).length;o<n;o++)s=d[o],a.insertNode(s[0]);return this.editor.selection.restore(),this.editor.trigger("valuechanged")},i.prototype._convertEl=function(t,e){var i,r,o;return o=[],(r=A(t)).is(e)?o.push(r):(i=A("<"+e+"/>").append(r.contents()),o.push(i)),o},i}(),C.Toolbar.addButton(N),e=function(){function t(){return t.__super__.constructor.apply(this,arguments)}return D(t,n),t.prototype.name="bold",t.prototype.icon="bold",t.prototype.htmlTag="b, strong",t.prototype.disableTag="pre",t.prototype.shortcut="cmd+b",t.prototype._init=function(){return this.editor.util.os.mac?this.title=this.title+" ( Cmd + b )":(this.title=this.title+" ( Ctrl + b )",this.shortcut="ctrl+b"),t.__super__._init.call(this)},t.prototype.status=function(t){var e;return null!=t&&this.setDisabled(t.is(this.disableTag)),!!this.disabled||(e=!0===document.queryCommandState("bold"),this.setActive(e),e)},t.prototype.command=function(){return document.execCommand("bold"),this.editor.util.support.oninput||this.editor.trigger("valuechanged"),A(document).trigger("selectionchange")},t}(),C.Toolbar.addButton(e),m=function(){function t(){return t.__super__.constructor.apply(this,arguments)}return D(t,n),t.prototype.name="italic",t.prototype.icon="italic",t.prototype.htmlTag="i",t.prototype.disableTag="pre",t.prototype.shortcut="cmd+i",t.prototype._init=function(){return this.editor.util.os.mac?this.title=this.title+" ( Cmd + i )":(this.title=this.title+" ( Ctrl + i )",this.shortcut="ctrl+i"),t.__super__._init.call(this)},t.prototype.status=function(t){var e;return null!=t&&this.setDisabled(t.is(this.disableTag)),this.disabled?this.disabled:(e=!0===document.queryCommandState("italic"),this.setActive(e),e)},t.prototype.command=function(){return document.execCommand("italic"),this.editor.util.support.oninput||this.editor.trigger("valuechanged"),A(document).trigger("selectionchange")},t}(),C.Toolbar.addButton(m),M=function(){function t(){return t.__super__.constructor.apply(this,arguments)}return D(t,n),t.prototype.name="underline",t.prototype.icon="underline",t.prototype.htmlTag="u",t.prototype.disableTag="pre",t.prototype.shortcut="cmd+u",t.prototype.render=function(){return this.editor.util.os.mac?this.title=this.title+" ( Cmd + u )":(this.title=this.title+" ( Ctrl + u )",this.shortcut="ctrl+u"),t.__super__.render.call(this)},t.prototype.status=function(t){var e;return null!=t&&this.setDisabled(t.is(this.disableTag)),this.disabled?this.disabled:(e=!0===document.queryCommandState("underline"),this.setActive(e),e)},t.prototype.command=function(){return document.execCommand("underline"),this.editor.util.support.oninput||this.editor.trigger("valuechanged"),A(document).trigger("selectionchange")},t}(),C.Toolbar.addButton(M),h=function(){function e(){return e.__super__.constructor.apply(this,arguments)}return D(e,n),e.prototype.name="color",e.prototype.icon="tint",e.prototype.disableTag="pre",e.prototype.menu=!0,e.prototype.render=function(){var t;return t=1<=arguments.length?P.call(arguments,0):[],e.__super__.render.apply(this,t)},e.prototype.renderMenu=function(){return A('<ul class="color-list">\n  <li><a href="javascript:;" class="font-color font-color-1" data-color=""></a></li>\n  <li><a href="javascript:;" class="font-color font-color-2" data-color=""></a></li>\n  <li><a href="javascript:;" class="font-color font-color-3" data-color=""></a></li>\n  <li><a href="javascript:;" class="font-color font-color-4" data-color=""></a></li>\n  <li><a href="javascript:;" class="font-color font-color-5" data-color=""></a></li>\n  <li><a href="javascript:;" class="font-color font-color-6" data-color=""></a></li>\n  <li><a href="javascript:;" class="font-color font-color-7" data-color=""></a></li>\n  <li><a href="javascript:;" class="font-color font-color-default" data-color=""></a></li>\n</ul>').appendTo(this.menuWrapper),this.menuWrapper.on("mousedown",".color-list",function(){return!1}),this.menuWrapper.on("click",".font-color",(n=this,function(t){var e,i,r,o;if(n.wrapper.removeClass("menu-on"),(e=A(t.currentTarget)).hasClass("font-color-default")){if(!(0<(i=n.editor.body.find("p, li")).length))return;o=window.getComputedStyle(i[0],null).getPropertyValue("color"),r=n._convertRgbToHex(o)}else o=window.getComputedStyle(e[0],null).getPropertyValue("background-color"),r=n._convertRgbToHex(o);return r?(document.execCommand("foreColor",!1,r),n.editor.util.support.oninput?void 0:n.editor.trigger("valuechanged")):void 0}));var n},e.prototype._convertRgbToHex=function(t){var e;return(e=/rgb\((\d+),\s?(\d+),\s?(\d+)\)/g.exec(t))?function(t,e,i){var r;return"#"+(r=function(t){var e;return 1===(e=t.toString(16)).length?"0"+e:e})(t)+r(e)+r(i)}(1*e[1],1*e[2],1*e[3]):""},e}(),C.Toolbar.addButton(h),_=function(){function t(){return t.__super__.constructor.apply(this,arguments)}return D(t,n),t.prototype.type="",t.prototype.disableTag="pre, table",t.prototype.status=function(t){var e;return null!=t&&this.setDisabled(t.is(this.disableTag)),!!this.disabled||(null==t?this.active:(e="ul"===this.type?"ol":"ul",t.is(e)?(this.setActive(!1),!0):(this.setActive(t.is(this.htmlTag)),this.active)))},t.prototype.command=function(){var t,e,i,r,o,n,s,a,l,d,u,p,h,c,f,g;for(g=(p=this.editor.selection.getRange()).startContainer,s=p.endContainer,n=this.editor.util.closestBlockEl(g),e=this.editor.util.closestBlockEl(s),this.editor.selection.save(),p.setStartBefore(n[0]),p.setEndAfter(e[0]),n.is("li")&&e.is("li")&&(r=this.editor.util.furthestNode(n,"ul, ol"),i=this.editor.util.furthestNode(e,"ul, ol"),r.is(i)?(f=(a=function(t){var e;for(e=1;!t.parent().is(r);)e+=1,t=t.parent();return e})(n),o=a(e)<f?e.parent():n.parent(),p.setStartBefore(o[0]),p.setEndAfter(o[0])):(p.setStartBefore(r[0]),p.setEndAfter(i[0]))),t=A(p.extractContents()),c=[],t.children().each(function(a){return function(t,e){var i,r,o,n,s;for(s=[],o=0,n=(r=a._convertEl(e)).length;o<n;o++)i=r[o],s.push(c.length&&c[c.length-1].is(a.type)&&i.is(a.type)?c[c.length-1].append(i.children()):c.push(i));return s}}(this)),l=0,d=(h=c.reverse()).length;l<d;l++)u=h[l],p.insertNode(u[0]);return this.editor.selection.restore(),this.editor.trigger("valuechanged")},t.prototype._convertEl=function(t){var e,i,r,o,n,s,a,l,d,u;if(e=A(t),d=[],i="ul"===this.type?"ol":"ul",e.is(this.type))e.children("li").each((u=this,function(t,e){var i,r;return i=A(e).children("ul, ol").remove(),r=A("<p/>").append(A(e).html()||u.editor.util.phBr),d.push(r),0<i.length?d.push(i):void 0}));else if(e.is(i))r=A("<"+this.type+"/>").append(e.html()),d.push(r);else if(e.is("blockquote")){for(s=0,a=(l=e.children().get()).length;s<a;s++)o=l[s],n=this._convertEl(o);A.merge(d,n)}else e.is("table")||((r=A("<"+this.type+"><li></li></"+this.type+">")).find("li").append(e.html()||this.editor.util.phBr),d.push(r));return d},t}(),w=function(){function t(){return t.__super__.constructor.apply(this,arguments)}return D(t,_),t.prototype.type="ol",t.prototype.name="ol",t.prototype.icon="list-ol",t.prototype.htmlTag="ol",t.prototype.shortcut="cmd+/",t.prototype._init=function(){return this.editor.util.os.mac?this.title=this.title+" ( Cmd + / )":(this.title=this.title+" ( ctrl + / )",this.shortcut="ctrl+/"),t.__super__._init.call(this)},t}(),I=function(){function t(){return t.__super__.constructor.apply(this,arguments)}return D(t,_),t.prototype.type="ul",t.prototype.name="ul",t.prototype.icon="list-ul",t.prototype.htmlTag="ul",t.prototype.shortcut="cmd+.",t.prototype._init=function(){return this.editor.util.os.mac?this.title=this.title+" ( Cmd + . )":(this.title=this.title+" ( Ctrl + . )",this.shortcut="ctrl+."),t.__super__._init.call(this)},t}(),C.Toolbar.addButton(w),C.Toolbar.addButton(I),t=function(){function t(){return t.__super__.constructor.apply(this,arguments)}return D(t,n),t.prototype.name="blockquote",t.prototype.icon="quote-left",t.prototype.htmlTag="blockquote",t.prototype.disableTag="pre, table",t.prototype.command=function(){var t,e,i,r,o,n,s,a,l,d,u;for(u=(a=this.editor.selection.getRange()).startContainer,r=a.endContainer,i=this.editor.util.furthestBlockEl(u),e=this.editor.util.furthestBlockEl(r),this.editor.selection.save(),a.setStartBefore(i[0]),a.setEndAfter(e[0]),t=A(a.extractContents()),d=[],t.children().each(function(a){return function(t,e){var i,r,o,n,s;for(s=[],o=0,n=(r=a._convertEl(e)).length;o<n;o++)i=r[o],s.push(d.length&&d[d.length-1].is(a.htmlTag)&&i.is(a.htmlTag)?d[d.length-1].append(i.children()):d.push(i));return s}}(this)),o=0,n=(l=d.reverse()).length;o<n;o++)s=l[o],a.insertNode(s[0]);return this.editor.selection.restore(),this.editor.trigger("valuechanged")},t.prototype._convertEl=function(t){var e,i,r;return e=A(t),r=[],e.is(this.htmlTag)?e.children().each(function(t,e){return r.push(A(e))}):(i=A("<"+this.htmlTag+"/>").append(e),r.push(i)),r},t}(),C.Toolbar.addButton(t),l=function(){function o(){return o.__super__.constructor.apply(this,arguments)}return D(o,n),o.prototype.name="code",o.prototype.icon="code",o.prototype.htmlTag="pre",o.prototype.disableTag="li, table",o.prototype._init=function(){return o.__super__._init.call(this),this.editor.on("decorate",(r=this,function(t,e){return e.find("pre").each(function(t,e){return r.decorate(A(e))})})),this.editor.on("undecorate",(i=this,function(t,e){return e.find("pre").each(function(t,e){return i.undecorate(A(e))})}));var i,r},o.prototype.render=function(){var t;return t=1<=arguments.length?P.call(arguments,0):[],o.__super__.render.apply(this,t),this.popover=new d({button:this})},o.prototype.status=function(t){var e;return e=o.__super__.status.call(this,t),this.active?this.popover.show(t):this.editor.util.isBlockNode(t)&&this.popover.hide(),e},o.prototype.decorate=function(t){var e;return e=t.attr("data-lang"),t.removeClass(),e&&-1!==e?t.addClass("lang-"+e):void 0},o.prototype.undecorate=function(t){var e;return e=t.attr("data-lang"),t.removeClass(),e&&-1!==e?t.addClass("lang-"+e):void 0},o.prototype.command=function(){var t,e,i,r,o,n,s,a,l,d,u;for(u=(a=this.editor.selection.getRange()).startContainer,r=a.endContainer,i=this.editor.util.closestBlockEl(u),e=this.editor.util.closestBlockEl(r),a.setStartBefore(i[0]),a.setEndAfter(e[0]),t=A(a.extractContents()),d=[],t.children().each(function(a){return function(t,e){var i,r,o,n,s;for(s=[],o=0,n=(r=a._convertEl(e)).length;o<n;o++)i=r[o],s.push(d.length&&d[d.length-1].is(a.htmlTag)&&i.is(a.htmlTag)?d[d.length-1].append(i.contents()):d.push(i));return s}}(this)),o=0,n=(l=d.reverse()).length;o<n;o++)s=l[o],a.insertNode(s[0]);return this.editor.selection.setRangeAtEndOf(d[0]),this.editor.trigger("valuechanged")},o.prototype._convertEl=function(t){var e,i,r,o;return o=[],(e=A(t)).is(this.htmlTag)?i=A("<p/>").append(e.html().replace("\n","<br/>")):(r=!e.text()&&1===e.children().length&&e.children().is("br")?"\n":this.editor.formatter.clearHtml(e),i=A("<"+this.htmlTag+"/>").text(r)),o.push(i),o},o}(),d=function(){function e(){return e.__super__.constructor.apply(this,arguments)}return D(e,T),e.prototype._tpl='<div class="code-settings">\n  <div class="settings-field">\n    <select class="select-lang">\n      <option value="-1">\u9009\u62e9\u7a0b\u5e8f\u8bed\u8a00</option>\n      <option value="bash">Bash</option>\n      <option value="c++">C++</option>\n      <option value="cs">C#</option>\n      <option value="css">CSS</option>\n      <option value="erlang">Erlang</option>\n      <option value="less">Less</option>\n      <option value="scss">Sass</option>\n      <option value="diff">Diff</option>\n      <option value="coffeeScript">CoffeeScript</option>\n      <option value="html">Html,XML</option>\n      <option value="json">JSON</option>\n      <option value="java">Java</option>\n      <option value="js">JavaScript</option>\n      <option value="markdown">Markdown</option>\n      <option value="oc">Objective C</option>\n      <option value="php">PHP</option>\n      <option value="perl">Perl</option>\n      <option value="python">Python</option>\n      <option value="ruby">Ruby</option>\n      <option value="sql">SQL</option>\n    </select>\n  </div>\n</div>',e.prototype.render=function(){return this.el.addClass("code-popover").append(this._tpl),this.selectEl=this.el.find(".select-lang"),this.selectEl.on("change",(e=this,function(){var t;return e.lang=e.selectEl.val(),t=e.target.hasClass("selected"),e.target.removeClass().removeAttr("data-lang"),-1!==e.lang&&(e.target.addClass("lang-"+e.lang),e.target.attr("data-lang",e.lang)),t?e.target.addClass("selected"):void 0})),this.editor.on("valuechanged",(t=this,function(){return t.active?t.refresh():void 0}));var t,e},e.prototype.show=function(){var t;return t=1<=arguments.length?P.call(arguments,0):[],e.__super__.show.apply(this,t),this.lang=this.target.attr("data-lang"),this.selectEl.val(null!=this.lang?this.lang:-1)},e}(),C.Toolbar.addButton(l),y=function(){function e(){return e.__super__.constructor.apply(this,arguments)}return D(e,n),e.prototype.name="link",e.prototype.icon="link",e.prototype.htmlTag="a",e.prototype.disableTag="pre",e.prototype.render=function(){var t;return t=1<=arguments.length?P.call(arguments,0):[],e.__super__.render.apply(this,t),this.popover=new b({button:this})},e.prototype.status=function(t){var e;return null!=t&&this.setDisabled(t.is(this.disableTag)),!!this.disabled||(null==t||(e=!0,!t.is(this.htmlTag)||t.is('[class^="simditor-"]')?(this.setActive(!1),e=!1):this.editor.selection.rangeAtEndOf(t)?(this.setActive(!0),e=!1):this.setActive(!0),e?this.popover.show(t):this.editor.util.isBlockNode(t)&&this.popover.hide()),this.active)},e.prototype.command=function(){var t,e,i,r,o,n,s,a,l,d,u;return a=this.editor.selection.getRange(),this.active?(i=A(a.commonAncestorContainer).closest("a"),d=document.createTextNode(i.text()),i.replaceWith(d),a.selectNode(d)):(l=a.startContainer,n=a.endContainer,o=this.editor.util.closestBlockEl(l),e=this.editor.util.closestBlockEl(n),t=A(a.extractContents()),s=this.editor.formatter.clearHtml(t.contents(),!1),i=A("<a/>",{href:"http://www.example.com",target:"_blank",text:s||this._t("linkText")}),o[0]===e[0]?a.insertNode(i[0]):(r=A("<p/>").append(i),a.insertNode(r[0])),a.selectNodeContents(i[0]),this.popover.one("popovershow",(u=this,function(){return s?(u.popover.urlEl.focus(),u.popover.urlEl[0].select()):(u.popover.textEl.focus(),u.popover.textEl[0].select())}))),
this.editor.selection.selectRange(a),this.editor.trigger("valuechanged")},e}(),b=function(){function e(){return e.__super__.constructor.apply(this,arguments)}return D(e,T),e.prototype.render=function(){var t,i,e,r,o;return t='<div class="link-settings">\n  <div class="settings-field">\n    <label>'+this._t("text")+'</label>\n    <input class="link-text" type="text"/>\n    <a class="btn-unlink" href="javascript:;" title="'+this._t("removeLink")+'" tabindex="-1"><span class="simditor-icon simditor-icon-unlink"></span></a>\n  </div>\n  <div class="settings-field">\n    <label>'+this._t("linkUrl")+'</label>\n    <input class="link-url" type="text"/>\n  </div>\n</div>',this.el.addClass("link-popover").append(t),this.textEl=this.el.find(".link-text"),this.urlEl=this.el.find(".link-url"),this.unlinkEl=this.el.find(".btn-unlink"),this.textEl.on("keyup",(o=this,function(t){return 13!==t.which?o.target.text(o.textEl.val()):void 0})),this.urlEl.on("keyup",(r=this,function(t){var e;if(13!==t.which)return e=r.urlEl.val(),!/https?:\/\/|^\//gi.test(e)&&e&&(e="http://"+e),r.target.attr("href",e)})),A([this.urlEl[0],this.textEl[0]]).on("keydown",(e=this,function(t){return 13===t.which||27===t.which||!t.shiftKey&&9===t.which&&A(t.target).hasClass("link-url")?(t.preventDefault(),setTimeout(function(){var t;return t=document.createRange(),e.editor.selection.setRangeAfter(e.target,t),e.hide(),e.editor.trigger("valuechanged")},0)):void 0})),this.unlinkEl.on("click",(i=this,function(){var t,e;return e=document.createTextNode(i.target.text()),i.target.replaceWith(e),i.hide(),t=document.createRange(),i.editor.selection.setRangeAfter(e,t),i.editor.trigger("valuechanged")}))},e.prototype.show=function(){var t;return t=1<=arguments.length?P.call(arguments,0):[],e.__super__.show.apply(this,t),this.textEl.val(this.target.text()),this.urlEl.val(this.target.attr("href"))},e}(),C.Toolbar.addButton(y),o=function(){function a(){return a.__super__.constructor.apply(this,arguments)}return D(a,n),a.prototype.name="image",a.prototype.icon="picture-o",a.prototype.htmlTag="img",a.prototype.disableTag="pre, table",a.prototype.defaultImage="",a.prototype.needFocus=!1,a.prototype._init=function(){var t,e,i,r,n,o,s;if(this.editor.opts.imageButton)if(Array.isArray(this.editor.opts.imageButton))for(this.menu=[],e=0,i=(r=this.editor.opts.imageButton).length;e<i;e++)t=r[e],this.menu.push({name:t+"-image",text:this._t(t+"Image")});else this.menu=!1;else this.menu=null!=this.editor.uploader&&[{name:"upload-image",text:this._t("uploadImage")},{name:"external-image",text:this._t("externalImage")}];return this.defaultImage=this.editor.opts.defaultImage,this.editor.body.on("click","img:not([data-non-image])",(s=this,function(t){var e,i;return e=A(t.currentTarget),(i=document.createRange()).selectNode(e[0]),s.editor.selection.selectRange(i),s.editor.util.support.onselectionchange||s.editor.trigger("selectionchanged"),!1})),this.editor.body.on("mouseup","img:not([data-non-image])",function(){return!1}),this.editor.on("selectionchanged.image",(o=this,function(){var t,e,i;return null!=(i=o.editor.selection.getRange())?1===(t=A(i.cloneContents()).contents()).length&&t.is("img:not([data-non-image])")?(e=A(i.startContainer).contents().eq(i.startOffset),o.popover.show(e)):o.popover.hide():void 0})),this.editor.on("valuechanged.image",(n=this,function(){var t;return 0<(t=n.editor.wrapper.find(".simditor-image-loading")).length?t.each(function(t,e){var i,r,o;return!((i=(r=A(e)).data("img"))&&0<i.parent().length)&&(r.remove(),i&&(o=i.data("file"))&&(n.editor.uploader.cancel(o),n.editor.body.find("img.uploading").length<1))?n.editor.uploader.trigger("uploadready",[o]):void 0}):void 0})),a.__super__._init.call(this)},a.prototype.render=function(){var t;return t=1<=arguments.length?P.call(arguments,0):[],a.__super__.render.apply(this,t),this.popover=new s({button:this}),"upload"===this.editor.opts.imageButton?this._initUploader(this.el):void 0},a.prototype.renderMenu=function(){return a.__super__.renderMenu.call(this),this._initUploader()},a.prototype._initUploader=function(t){var e,i,a,s,r,o,n;return null==t&&(t=this.menuEl.find(".menu-item-upload-image")),null==this.editor.uploader?void this.el.find(".btn-upload").remove():(e=null,n=this,(i=function(){return e&&e.remove(),e=A('<input type="file" title="'+n._t("uploadImage")+'" accept="image/*">').appendTo(t)})(),t.on("click mousedown","input[type=file]",function(t){return t.stopPropagation()}),t.on("change","input[type=file]",(o=this,function(){return o.editor.inputManager.focused?(o.editor.uploader.upload(e,{inline:!0}),i()):(o.editor.one("focus",function(){return o.editor.uploader.upload(e,{inline:!0}),i()}),o.editor.focus()),o.wrapper.removeClass("menu-on")})),this.editor.uploader.on("beforeupload",(r=this,function(t,e){var i;if(e.inline)return e.img?i=A(e.img):(i=r.createImage(e.name),e.img=i),i.addClass("uploading"),i.data("file",e),r.editor.uploader.readImageFile(e.obj,function(t){var e;if(i.hasClass("uploading"))return e=t?t.src:r.defaultImage,r.loadImage(i,e,function(){return r.popover.active?(r.popover.refresh(),r.popover.srcEl.val(r._t("uploading")).prop("disabled",!0)):void 0})})})),this.editor.uploader.on("uploadprogress",A.proxy(this.editor.util.throttle(function(t,e,i,r){var o,n,s;if(e.inline&&(n=e.img.data("mask")))return(o=n.data("img")).hasClass("uploading")&&0<o.parent().length?(99<(s=(100*(s=i/r)).toFixed(0))&&(s=99),n.find(".progress").height(100-s+"%")):void n.remove()},500),this)),this.editor.uploader.on("uploadsuccess",(s=this,function(t,e,i){var r,o,n;if(e.inline&&(r=e.img).hasClass("uploading")&&0<r.parent().length){if(r.removeData("file"),r.removeClass("uploading").removeClass("loading"),(o=r.data("mask"))&&o.remove(),r.removeData("mask"),"object"!=typeof i)try{i=A.parseJSON(i)}catch(d){i={success:!1}}return!1===i.success?(n=i.msg||s._t("uploadFailed"),alert(n),r.attr("src",s.defaultImage)):r.attr("src",i.file_path),s.popover.active&&(s.popover.srcEl.prop("disabled",!1),s.popover.srcEl.val(i.file_path)),s.editor.trigger("valuechanged"),s.editor.body.find("img.uploading").length<1?s.editor.uploader.trigger("uploadready",[e,i]):void 0}})),this.editor.uploader.on("uploaderror",(a=this,function(t,e,i){var r,o,n,s;if(e.inline&&"abort"!==i.statusText){if(i.responseText){try{n=(s=A.parseJSON(i.responseText)).msg}catch(h){n=a._t("uploadError")}alert(n)}if((r=e.img).hasClass("uploading")&&0<r.parent().length)return r.removeData("file"),r.removeClass("uploading").removeClass("loading"),(o=r.data("mask"))&&o.remove(),r.removeData("mask"),r.attr("src",a.defaultImage),a.popover.active&&(a.popover.srcEl.prop("disabled",!1),a.popover.srcEl.val(a.defaultImage)),a.editor.trigger("valuechanged"),a.editor.body.find("img.uploading").length<1?a.editor.uploader.trigger("uploadready",[e,s]):void 0}})))},a.prototype.status=function(t){return null!=t&&this.setDisabled(t.is(this.disableTag)),!!this.disabled||void 0},a.prototype.loadImage=function(i,r,o){var n,s,a,l,d;return d=this,a=function(){var t,e;return t=i.offset(),e=d.editor.wrapper.offset(),n.css({top:t.top-e.top,left:t.left-e.left,width:i.width(),height:i.height()}).show()},i.addClass("loading"),(n=i.data("mask"))||(n=A('<div class="simditor-image-loading"><div class="progress"></div></div>').hide().appendTo(this.editor.wrapper),a(),i.data("mask",n),n.data("img",i)),(s=new Image).onload=(l=this,function(){var t,e;if(i.hasClass("loading")||i.hasClass("uploading"))return e=s.width,t=s.height,i.attr({src:r,"data-image-size":e+","+t}).removeClass("loading"),i.hasClass("uploading")?(l.editor.util.reflow(l.editor.body),a()):(n.remove(),i.removeData("mask")),o(s)}),s.onerror=function(){return o(!1),n.remove(),i.removeData("mask").removeClass("loading")},s.src=r},a.prototype.createImage=function(t){var e,i,r,o;return null==t&&(t="Image"),this.editor.inputManager.focused||this.editor.focus(),(o=this.editor.selection.getRange()).deleteContents(),(e=this.editor.util.closestBlockEl()).is("p")&&!this.editor.util.isEmptyNode(e)&&(e=A("<p/>").append(this.editor.util.phBr).insertAfter(e),this.editor.selection.setRangeAtStartOf(e,o)),i=A("<img/>").attr("alt",t),o.insertNode(i[0]),0<(r=e.next("p")).length||(r=A("<p/>").append(this.editor.util.phBr).insertAfter(e)),this.editor.selection.setRangeAtStartOf(r),i},a.prototype.command=function(t){var e,i;return e=this.createImage(),this.loadImage(e,t||this.defaultImage,(i=this,function(){return i.editor.trigger("valuechanged"),i.editor.util.reflow(e),e.click(),i.popover.one("popovershow",function(){return i.popover.srcEl.focus(),i.popover.srcEl[0].select()})}))},a}(),s=function(){function i(){return i.__super__.constructor.apply(this,arguments)}return D(i,T),i.prototype.offset={top:6,left:-4},i.prototype.render=function(){var t,e,i,r,o,n,s,a,l,d;return t='<div class="link-settings">\n  <div class="settings-field">\n    <label>'+this._t("imageUrl")+'</label>\n    <input class="image-src" type="text" tabindex="1" />\n    <a class="btn-upload" href="javascript:;" title="'+this._t("uploadImage")+'" tabindex="-1">\n      <span class="simditor-icon simditor-icon-upload"></span>\n    </a>\n  </div>\n  <div class=\'settings-field\'>\n    <label>'+this._t("imageAlt")+'</label>\n    <input class="image-alt" id="image-alt" type="text" tabindex="1" />\n  </div>\n  <div class="settings-field">\n    <label>'+this._t("imageSize")+'</label>\n    <input class="image-size" id="image-width" type="text" tabindex="2" />\n    <span class="times">\xd7</span>\n    <input class="image-size" id="image-height" type="text" tabindex="3" />\n    <a class="btn-restore" href="javascript:;" title="'+this._t("restoreImageSize")+'" tabindex="-1">\n      <span class="simditor-icon simditor-icon-undo"></span>\n    </a>\n  </div>\n</div>',this.el.addClass("image-popover").append(t),this.srcEl=this.el.find(".image-src"),this.widthEl=this.el.find("#image-width"),this.heightEl=this.el.find("#image-height"),this.altEl=this.el.find("#image-alt"),this.srcEl.on("keydown",(d=this,function(t){return 13!==t.which||d.target.hasClass("uploading")?void 0:(t.preventDefault(),d.button.editor.body.focus(),d.button.editor.selection.setRangeAfter(d.target),d.hide())})),this.srcEl.on("blur",(l=this,function(){return l._loadImage(l.srcEl.val())})),this.el.find(".image-size").on("blur",(a=this,function(t){return a._resizeImg(A(t.currentTarget)),a.el.data("popover").refresh()})),this.el.find(".image-size").on("keyup",(s=this,function(t){var e;return e=A(t.currentTarget),13!==t.which&&27!==t.which&&9!==t.which?s._resizeImg(e,!0):void 0})),this.el.find(".image-size").on("keydown",(n=this,function(t){var e;return e=A(t.currentTarget),13===t.which||27===t.which?(t.preventDefault(),13===t.which?n._resizeImg(e):n._restoreImg(),n.button.editor.body.focus(),n.button.editor.selection.setRangeAfter(n.target),n.hide()):9===t.which?n.el.data("popover").refresh():void 0})),this.altEl.on("keydown",(o=this,function(t){return 13===t.which?(t.preventDefault(),o.button.editor.body.focus(),o.button.editor.selection.setRangeAfter(o.target),o.hide()):void 0})),this.altEl.on("keyup",(r=this,function(t){return 13!==t.which&&27!==t.which&&9!==t.which?(r.alt=r.altEl.val(),r.target.attr("alt",r.alt)):void 0})),this.el.find(".btn-restore").on("click",(i=this,function(){return i._restoreImg(),i.el.data("popover").refresh()})),this.editor.on("valuechanged",(e=this,function(){return e.active?e.refresh():void 0})),this._initUploader()},i.prototype._initUploader=function(){var t,e,i,r;return t=this.el.find(".btn-upload"),null==this.editor.uploader?void t.remove():(r=this,(e=function(){return r.input&&r.input.remove(),r.input=A('<input type="file" title="'+r._t("uploadImage")+'" accept="image/*">').appendTo(t)})(),this.el.on("click mousedown","input[type=file]",function(t){return t.stopPropagation()}),this.el.on("change","input[type=file]",(i=this,function(){return i.editor.uploader.upload(i.input,{inline:!0,img:i.target}),e()})))},i.prototype._resizeImg=function(t,e){var i,r,o;return null==e&&(e=!1),r=1*t.val(),A.isNumeric(r)||r<0?(t.is(this.widthEl)?(i=this.height*r/this.width,this.heightEl.val(i)):(o=this.width*r/this.height,this.widthEl.val(o)),e||this.target.attr({width:o||r,height:i||r}),this.editor.trigger("valuechanged")):void 0},i.prototype._restoreImg=function(){var t,e;return e=(null!=(t=this.target.data("image-size"))?t.split(","):void 0)||[this.width,this.height],this.target.attr({width:1*e[0],height:1*e[1]}),this.widthEl.val(e[0]),this.heightEl.val(e[1]),this.editor.trigger("valuechanged")},i.prototype._loadImage=function(i,r){return/^data:image/.test(i)&&!this.editor.uploader?void(r&&r(!1)):this.button.loadImage(this.target,i,(o=this,function(t){var e;if(t)return o.active&&(o.width=t.width,o.height=t.height,o.widthEl.val(o.width),o.heightEl.val(o.height),o.target.removeAttr("width").removeAttr("height")),/^data:image/.test(i)?((e=o.editor.util.dataURLtoBlob(i)).name="Base64 Image.png",o.editor.uploader.upload(e,{inline:!0,img:o.target})):o.editor.trigger("valuechanged"),r?r(t):void 0}));var o},i.prototype.show=function(){var t,e;return e=1<=arguments.length?P.call(arguments,0):[],i.__super__.show.apply(this,e),t=this.target,this.width=t.width(),this.height=t.height(),this.alt=t.attr("alt"),t.hasClass("uploading")?this.srcEl.val(this._t("uploading")).prop("disabled",!0):(this.srcEl.val(t.attr("src")).prop("disabled",!1),this.widthEl.val(this.width),this.heightEl.val(this.height),this.altEl.val(this.alt))},i}(),C.Toolbar.addButton(o),c=function(){function t(){return t.__super__.constructor.apply(this,arguments)}return D(t,n),t.prototype.name="indent",t.prototype.icon="indent",t.prototype._init=function(){return this.title=this._t(this.name)+" (Tab)",t.__super__._init.call(this)},t.prototype.status=function(){return!0},t.prototype.command=function(){return this.editor.indentation.indent()},t}(),C.Toolbar.addButton(c),x=function(){function t(){return t.__super__.constructor.apply(this,arguments)}return D(t,n),t.prototype.name="outdent",t.prototype.icon="outdent",t.prototype._init=function(){return this.title=this._t(this.name)+" (Shift + Tab)",t.__super__._init.call(this)},t.prototype.status=function(){return!0},t.prototype.command=function(){return this.editor.indentation.indent(!0)},t}(),C.Toolbar.addButton(x),r=function(){function t(){return t.__super__.constructor.apply(this,arguments)}return D(t,n),t.prototype.name="hr",t.prototype.icon="minus",t.prototype.htmlTag="hr",t.prototype.status=function(){return!0},t.prototype.command=function(){var t,e,i;return 0<(i=this.editor.util.furthestBlockEl()).next().length?this.editor.selection.save():e=A("<p/>").append(this.editor.util.phBr),t=A("<hr/>").insertAfter(i),e?(e.insertAfter(t),this.editor.selection.setRangeAtStartOf(e)):this.editor.selection.restore(),this.editor.trigger("valuechanged")},t}(),C.Toolbar.addButton(r),R=function(){function e(){return e.__super__.constructor.apply(this,arguments)}return D(e,n),e.prototype.name="table",e.prototype.icon="table",e.prototype.htmlTag="table",e.prototype.disableTag="pre, li, blockquote",e.prototype.menu=!0,e.prototype._init=function(){return e.__super__._init.call(this),A.merge(this.editor.formatter._allowedTags,["tbody","tr","td","colgroup","col"]),A.extend(this.editor.formatter._allowedAttributes,{td:["rowspan","colspan"],col:["width"]}),this._initShortcuts(),this.editor.on("decorate",(o=this,function(t,e){return e.find("table").each(function(t,e){return o.decorate(A(e))})})),this.editor.on("undecorate",(r=this,function(t,e){return e.find("table").each(function(t,e){return r.undecorate(A(e))})})),this.editor.on("selectionchanged.table",(i=this,function(){var t,e;return i.editor.body.find(".simditor-table td").removeClass("active"),null!=(e=i.editor.selection.getRange())?(t=A(e.commonAncestorContainer),e.collapsed&&t.is(".simditor-table")&&(t=t.find(i.editor.selection.rangeAtStartOf(t)?"td:first":"td:last"),i.editor.selection.setRangeAtEndOf(t)),t.closest("td",i.editor.body).addClass("active")):void 0})),this.editor.on("blur.table",(t=this,function(){return t.editor.body.find(".simditor-table td").removeClass("active")})),this.editor.inputManager.addKeystrokeHandler("38","td",(s=this,function(t,e){var i,r,o;return 0<(i=(r=e.parent("tr")).prev("tr")).length&&(o=r.find("td").index(e),s.editor.selection.setRangeAtEndOf(i.find("td").eq(o))),!0})),this.editor.inputManager.addKeystrokeHandler("40","td",(n=this,function(t,e){var i,r,o;return 0<(i=(r=e.parent("tr")).next("tr")).length&&(o=r.find("td").index(e),n.editor.selection.setRangeAtEndOf(i.find("td").eq(o))),!0}));var n,s,t,i,r,o},e.prototype.initResize=function(t){var s,a,c;return c=t.parent(".simditor-table"),(s=t.find("colgroup")).length<1&&(s=A("<colgroup/>").prependTo(t),t.find("tr:first td").each(function(){return A("<col/>").appendTo(s)}),this.refreshTableWidth(t)),a=A('<div class="simditor-resize-handle" contenteditable="false"></div>').appendTo(c),c.on("mousemove","td",function(t){var e,i,r,o,n;if(!c.hasClass("resizing"))return i=A(t.currentTarget),t.pageX-A(t.currentTarget).offset().left<5&&0<i.prev().length&&(i=i.prev()),i.next("td").length<1?void a.hide():(null!=(o=a.data("td"))?o.is(i):void 0)?void a.show():(r=i.parent().find("td").index(i),e=s.find("col").eq(r),(null!=(n=a.data("col"))?n.is(e):void 0)?void a.show():a.css("left",i.position().left+i.outerWidth()-5).data("td",i).data("col",e).show())}),c.on("mouseleave",function(){return a.hide()}),c.on("mousedown",".simditor-resize-handle",function(t){var o,n,e,s,i,a,l,d,u,p,h;return e=(o=A(t.currentTarget)).data("td"),n=o.data("col"),i=e.next("td"),s=n.next("col"),p=t.pageX,d=1*e.outerWidth(),u=1*i.outerWidth(),l=parseFloat(o.css("left")),h=e.closest("table").width(),a=50,A(document).on("mousemove.simditor-resize-table",function(t){var e,i,r;return e=t.pageX-p,r=u-e,(i=d+e)<a?r=u-(e=(i=a)-d):r<a&&(i=d+(e=u-(r=a))),n.attr("width",i/h*100+"%"),s.attr("width",r/h*100+"%"),o.css("left",l+e)}),A(document).one("mouseup.simditor-resize-table",function(){return A(document).off(".simditor-resize-table"),c.removeClass("resizing")}),c.addClass("resizing"),!1})},e.prototype._initShortcuts=function(){return this.editor.inputManager.addShortcut("ctrl+alt+up",(r=this,function(){return r.editMenu.find(".menu-item[data-param=insertRowAbove]").click(),!1})),this.editor.inputManager.addShortcut("ctrl+alt+down",(i=this,function(){return i.editMenu.find(".menu-item[data-param=insertRowBelow]").click(),!1})),this.editor.inputManager.addShortcut("ctrl+alt+left",(e=this,function(){return e.editMenu.find(".menu-item[data-param=insertColLeft]").click(),!1})),this.editor.inputManager.addShortcut("ctrl+alt+right",(t=this,function(){return t.editMenu.find(".menu-item[data-param=insertColRight]").click(),!1}));var t,e,i,r},e.prototype.decorate=function(t){return 0<t.parent(".simditor-table").length&&this.undecorate(t),t.wrap('<div class="simditor-table"></div>'),this.initResize(t),t.parent()},e.prototype.undecorate=function(t){return 0<t.parent(".simditor-table").length?t.parent().replaceWith(t):void 0},e.prototype.renderMenu=function(){return A('<div class="menu-create-table">\n</div>\n<div class="menu-edit-table">\n  <ul>\n    <li><a tabindex="-1" unselectable="on" class="menu-item" href="javascript:;" data-param="deleteRow"><span>'+this._t("deleteRow")+'</span></a></li>\n    <li><a tabindex="-1" unselectable="on" class="menu-item" href="javascript:;" data-param="insertRowAbove"><span>'+this._t("insertRowAbove")+' ( Ctrl + Alt + \u2191 )</span></a></li>\n    <li><a tabindex="-1" unselectable="on" class="menu-item" href="javascript:;" data-param="insertRowBelow"><span>'+this._t("insertRowBelow")+' ( Ctrl + Alt + \u2193 )</span></a></li>\n    <li><span class="separator"></span></li>\n    <li><a tabindex="-1" unselectable="on" class="menu-item" href="javascript:;" data-param="deleteCol"><span>'+this._t("deleteColumn")+'</span></a></li>\n    <li><a tabindex="-1" unselectable="on" class="menu-item" href="javascript:;" data-param="insertColLeft"><span>'+this._t("insertColumnLeft")+' ( Ctrl + Alt + \u2190 )</span></a></li>\n    <li><a tabindex="-1" unselectable="on" class="menu-item" href="javascript:;" data-param="insertColRight"><span>'+this._t("insertColumnRight")+' ( Ctrl + Alt + \u2192 )</span></a></li>\n    <li><span class="separator"></span></li>\n    <li><a tabindex="-1" unselectable="on" class="menu-item" href="javascript:;" data-param="deleteTable"><span>'+this._t("deleteTable")+"</span></a></li>\n  </ul>\n</div>").appendTo(this.menuWrapper),this.createMenu=this.menuWrapper.find(".menu-create-table"),this.editMenu=this.menuWrapper.find(".menu-edit-table"),this.createTable(6,6).appendTo(this.createMenu),this.createMenu.on("mouseenter","td",(o=this,function(t){var e,i,r;return o.createMenu.find("td").removeClass("selected"),r=(i=(e=A(t.currentTarget)).parent()).find("td").index(e)+1,i.prevAll("tr").addBack().find("td:lt("+r+")").addClass("selected")})),this.createMenu.on("mouseleave",function(t){return A(t.currentTarget).find("td").removeClass("selected")}),this.createMenu.on("mousedown","td",(a=this,function(t){var e,i,r,o,n,s;return a.wrapper.removeClass("menu-on"),a.editor.inputManager.focused?(n=(o=(r=A(t.currentTarget)).parent()).find("td").index(r)+1,s=o.prevAll("tr").length+1,i=a.createTable(s,n,!0),e=a.editor.util.closestBlockEl(),a.editor.util.isEmptyNode(e)?e.replaceWith(i):e.after(i),a.decorate(i),a.editor.selection.setRangeAtStartOf(i.find("td:first")),a.editor.trigger("valuechanged"),!1):void 0}));var a,o},e.prototype.createTable=function(t,e,i){var r,o,n,s,a,l,d,u;for(r=A("<table/>"),o=A("<tbody/>").appendTo(r),a=0,d=t;0<=d?a<d:d<a;0<=d?++a:--a)for(s=A("<tr/>").appendTo(o),l=0,u=e;0<=u?l<u:u<l;0<=u?++l:--l)n=A("<td/>").appendTo(s),i&&n.append(this.editor.util.phBr);return r},e.prototype.refreshTableWidth=function(t){var i,r;return r=t.width(),i=t.find("col"),t.find("tr:first td").each(function(t,e){return i.eq(t).attr("width",A(e).outerWidth()/r*100+"%")})},e.prototype.setActive=function(t){return e.__super__.setActive.call(this,t),t?(this.createMenu.hide(),this.editMenu.show()):(this.createMenu.show(),this.editMenu.hide())},e.prototype.deleteRow=function(t){var e,i,r;return(i=t.parent("tr")).siblings("tr").length<1?this.deleteTable(t):(0<(e=i.next("tr")).length||(e=i.prev("tr")),r=i.find("td").index(t),i.remove(),this.editor.selection.setRangeAtEndOf(e.find("td").eq(r)))},e.prototype.insertRow=function(t,e){var i,r,o,n,s,a,l;for(null==e&&(e="after"),r=(o=t.parent("tr")).closest("table"),n=0,r.find("tr").each(function(t,e){return n=Math.max(n,A(e).find("td").length)}),i=A("<tr/>"),a=1,l=n;1<=l?a<=l:l<=a;1<=l?++a:--a)A("<td/>").append(this.editor.util.phBr).appendTo(i);return o[e](i),s=o.find("td").index(t),this.editor.selection.setRangeAtStartOf(i.find("td").eq(s))},e.prototype.deleteCol=function(t){var e,i,r,o;return(r=t.parent("tr")).siblings("tr").length<1&&t.siblings("td").length<1?this.deleteTable(t):(o=r.find("td").index(t),0<(e=t.next("td")).length||(e=r.prev("td")),(i=r.closest("table")).find("col").eq(o).remove(),i.find("tr").each(function(t,e){return A(e).find("td").eq(o).remove()}),this.refreshTableWidth(i),this.editor.selection.setRangeAtEndOf(e))},e.prototype.insertCol=function(t,r){var e,i,o,n,s,a,l,d,u;return null==r&&(r="after"),s=t.parent("tr"),a=s.find("td").index(t),e=(n=t.closest("table")).find("col").eq(a),n.find("tr").each((u=this,function(t,e){var i;return i=A("<td/>").append(u.editor.util.phBr),A(e).find("td").eq(a)[r](i)})),i=A("<col/>"),e[r](i),l=n.width(),d=Math.max(parseFloat(e.attr("width"))/2,50/l*100),e.attr("width",d+"%"),i.attr("width",d+"%"),this.refreshTableWidth(n),o="after"===r?t.next("td"):t.prev("td"),this.editor.selection.setRangeAtStartOf(o)},e.prototype.deleteTable=function(t){var e,i;return e=(i=t.closest(".simditor-table")).next("p"),i.remove(),0<e.length?this.editor.selection.setRangeAtStartOf(e):void 0},e.prototype.command=function(t){var e,i;if(i=this.editor.selection.getRange(),0<(e=A(i.commonAncestorContainer).closest("td")).length){if("deleteRow"===t)this.deleteRow(e);else if("insertRowAbove"===t)this.insertRow(e,"before");else if("insertRowBelow"===t)this.insertRow(e);else if("deleteCol"===t)this.deleteCol(e);else if("insertColLeft"===t)this.insertCol(e,"before");else if("insertColRight"===t)this.insertCol(e);else{if("deleteTable"!==t)return;this.deleteTable(e)}return this.editor.trigger("valuechanged")}},e}(),C.Toolbar.addButton(R),B=function(){function t(){return t.__super__.constructor.apply(this,arguments)}return D(t,n),t.prototype.name="strikethrough",t.prototype.icon="strikethrough",t.prototype.htmlTag="strike",t.prototype.disableTag="pre",t.prototype.status=function(t){var e;return null!=t&&this.setDisabled(t.is(this.disableTag)),!!this.disabled||(e=!0===document.queryCommandState("strikethrough"),this.setActive(e),e)},t.prototype.command=function(){return document.execCommand("strikethrough"),this.editor.util.support.oninput||this.editor.trigger("valuechanged"),A(document).trigger("selectionchange")},t}(),C.Toolbar.addButton(B),C});